import { ERR_INVALID_ARG_TYPE, ERR_INVALID_ARG_VALUE, ERR_INVALID_FILE_URL_HOST, ERR_INVALID_FILE_URL_PATH, ERR_INVALID_URL_SCHEME, } from "./_errors.ts";
import { CHAR_BACKWARD_SLASH, CHAR_FORWARD_SLASH, CHAR_LOWERCASE_A, CHAR_LOWERCASE_Z, } from "../path/_constants.ts";
import * as path from "./path.ts";
import { isWindows, osType } from "../_util/os.ts";
const forwardSlashRegEx = /\//g;
const percentRegEx = /%/g;
const backslashRegEx = /\\/g;
const newlineRegEx = /\n/g;
const carriageReturnRegEx = /\r/g;
const tabRegEx = /\t/g;
const _url = URL;
export { _url as URL };
export function format(urlObject, options) {
    if (options) {
        if (typeof options !== "object") {
            throw new ERR_INVALID_ARG_TYPE("options", "object", options);
        }
    }
    options = {
        auth: true,
        fragment: true,
        search: true,
        unicode: false,
        ...options,
    };
    let ret = urlObject.protocol;
    if (urlObject.host !== null) {
        ret += "//";
        const hasUsername = urlObject.username !== "";
        const hasPassword = urlObject.password !== "";
        if (options.auth && (hasUsername || hasPassword)) {
            if (hasUsername) {
                ret += urlObject.username;
            }
            if (hasPassword) {
                ret += `:${urlObject.password}`;
            }
            ret += "@";
        }
        ret += urlObject.host;
        if (urlObject.port) {
            ret += `:${urlObject.port}`;
        }
    }
    ret += urlObject.pathname;
    if (options.search) {
        ret += urlObject.search;
    }
    if (options.fragment) {
        ret += urlObject.hash;
    }
    return ret;
}
export function fileURLToPath(path) {
    if (typeof path === "string")
        path = new URL(path);
    else if (!(path instanceof URL)) {
        throw new ERR_INVALID_ARG_TYPE("path", ["string", "URL"], path);
    }
    if (path.protocol !== "file:") {
        throw new ERR_INVALID_URL_SCHEME("file");
    }
    return isWindows ? getPathFromURLWin(path) : getPathFromURLPosix(path);
}
function getPathFromURLWin(url) {
    const hostname = url.hostname;
    let pathname = url.pathname;
    for (let n = 0; n < pathname.length; n++) {
        if (pathname[n] === "%") {
            const third = pathname.codePointAt(n + 2) | 0x20;
            if ((pathname[n + 1] === "2" && third === 102) ||
                (pathname[n + 1] === "5" && third === 99)) {
                throw new ERR_INVALID_FILE_URL_PATH("must not include encoded \\ or / characters");
            }
        }
    }
    pathname = pathname.replace(forwardSlashRegEx, "\\");
    pathname = decodeURIComponent(pathname);
    if (hostname !== "") {
        return `\\\\${hostname}${pathname}`;
    }
    else {
        const letter = pathname.codePointAt(1) | 0x20;
        const sep = pathname[2];
        if (letter < CHAR_LOWERCASE_A ||
            letter > CHAR_LOWERCASE_Z ||
            sep !== ":") {
            throw new ERR_INVALID_FILE_URL_PATH("must be absolute");
        }
        return pathname.slice(1);
    }
}
function getPathFromURLPosix(url) {
    if (url.hostname !== "") {
        throw new ERR_INVALID_FILE_URL_HOST(osType);
    }
    const pathname = url.pathname;
    for (let n = 0; n < pathname.length; n++) {
        if (pathname[n] === "%") {
            const third = pathname.codePointAt(n + 2) | 0x20;
            if (pathname[n + 1] === "2" && third === 102) {
                throw new ERR_INVALID_FILE_URL_PATH("must not include encoded / characters");
            }
        }
    }
    return decodeURIComponent(pathname);
}
function encodePathChars(filepath) {
    if (filepath.includes("%")) {
        filepath = filepath.replace(percentRegEx, "%25");
    }
    if (!isWindows && filepath.includes("\\")) {
        filepath = filepath.replace(backslashRegEx, "%5C");
    }
    if (filepath.includes("\n")) {
        filepath = filepath.replace(newlineRegEx, "%0A");
    }
    if (filepath.includes("\r")) {
        filepath = filepath.replace(carriageReturnRegEx, "%0D");
    }
    if (filepath.includes("\t")) {
        filepath = filepath.replace(tabRegEx, "%09");
    }
    return filepath;
}
export function pathToFileURL(filepath) {
    const outURL = new URL("file://");
    if (isWindows && filepath.startsWith("\\\\")) {
        const paths = filepath.split("\\");
        if (paths.length <= 3) {
            throw new ERR_INVALID_ARG_VALUE("filepath", filepath, "Missing UNC resource path");
        }
        const hostname = paths[2];
        if (hostname.length === 0) {
            throw new ERR_INVALID_ARG_VALUE("filepath", filepath, "Empty UNC servername");
        }
        outURL.hostname = hostname;
        outURL.pathname = encodePathChars(paths.slice(3).join("/"));
    }
    else {
        let resolved = path.resolve(filepath);
        const filePathLast = filepath.charCodeAt(filepath.length - 1);
        if ((filePathLast === CHAR_FORWARD_SLASH ||
            (isWindows && filePathLast === CHAR_BACKWARD_SLASH)) &&
            resolved[resolved.length - 1] !== path.sep) {
            resolved += "/";
        }
        outURL.pathname = encodePathChars(resolved);
    }
    return outURL;
}
function urlToHttpOptions(url) {
    const options = {
        protocol: url.protocol,
        hostname: typeof url.hostname === "string" &&
            url.hostname.startsWith("[")
            ? url.hostname.slice(1, -1)
            : url.hostname,
        hash: url.hash,
        search: url.search,
        pathname: url.pathname,
        path: `${url.pathname || ""}${url.search || ""}`,
        href: url.href,
    };
    if (url.port !== "") {
        options.port = Number(url.port);
    }
    if (url.username || url.password) {
        options.auth = `${decodeURIComponent(url.username)}:${decodeURIComponent(url.password)}`;
    }
    return options;
}
export default {
    format,
    fileURLToPath,
    pathToFileURL,
    urlToHttpOptions,
    URL,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidXJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQXFCQSxPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLHFCQUFxQixFQUNyQix5QkFBeUIsRUFDekIseUJBQXlCLEVBQ3pCLHNCQUFzQixHQUN2QixNQUFNLGNBQWMsQ0FBQztBQUN0QixPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLGtCQUFrQixFQUNsQixnQkFBZ0IsRUFDaEIsZ0JBQWdCLEdBQ2pCLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxLQUFLLElBQUksTUFBTSxXQUFXLENBQUM7QUFDbEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRCxNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQztBQUNoQyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUM7QUFDMUIsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQzdCLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQztBQUMzQixNQUFNLG1CQUFtQixHQUFHLEtBQUssQ0FBQztBQUNsQyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUM7QUFFdkIsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQ2pCLE9BQU8sRUFBRSxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7QUFldkIsTUFBTSxVQUFVLE1BQU0sQ0FDcEIsU0FBYyxFQUNkLE9BS0M7SUFFRCxJQUFJLE9BQU8sRUFBRTtRQUNYLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQy9CLE1BQU0sSUFBSSxvQkFBb0IsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzlEO0tBQ0Y7SUFFRCxPQUFPLEdBQUc7UUFDUixJQUFJLEVBQUUsSUFBSTtRQUNWLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTSxFQUFFLElBQUk7UUFDWixPQUFPLEVBQUUsS0FBSztRQUNkLEdBQUcsT0FB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QUUsR0FBRyxDQUFDLFFBQVE7UUFDdEIsUUFBUSxFQUFFLE9BQU8sR0FBRyxDQUFDLFFBQVEsS0FBSyxRQUFRO1lBQ3RDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztZQUM5QixDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzNCLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUTtRQUNoQixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7UUFDZCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07UUFDbEIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1FBQ3RCLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksRUFBRSxFQUFFO1FBQ2hELElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtLQUNmLENBQUM7SUFDRixJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssRUFBRSxFQUFFO1FBQ25CLE9BQU8sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNqQztJQUNELElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQ2hDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQ2hELGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQ2pDLEVBQUUsQ0FBQztLQUNKO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELGVBQWU7SUFDYixNQUFNO0lBQ04sYUFBYTtJQUNiLGFBQWE7SUFDYixnQkFBZ0I7SUFDaEIsR0FBRztDQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYVxuLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZVxuLy8gXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nXG4vLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsXG4vLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0XG4vLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGVcbi8vIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkXG4vLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTXG4vLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GXG4vLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOXG4vLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSxcbi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUlxuLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRVxuLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IHtcbiAgRVJSX0lOVkFMSURfQVJHX1RZUEUsXG4gIEVSUl9JTlZBTElEX0FSR19WQUxVRSxcbiAgRVJSX0lOVkFMSURfRklMRV9VUkxfSE9TVCxcbiAgRVJSX0lOVkFMSURfRklMRV9VUkxfUEFUSCxcbiAgRVJSX0lOVkFMSURfVVJMX1NDSEVNRSxcbn0gZnJvbSBcIi4vX2Vycm9ycy50c1wiO1xuaW1wb3J0IHtcbiAgQ0hBUl9CQUNLV0FSRF9TTEFTSCxcbiAgQ0hBUl9GT1JXQVJEX1NMQVNILFxuICBDSEFSX0xPV0VSQ0FTRV9BLFxuICBDSEFSX0xPV0VSQ0FTRV9aLFxufSBmcm9tIFwiLi4vcGF0aC9fY29uc3RhbnRzLnRzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCIuL3BhdGgudHNcIjtcbmltcG9ydCB7IGlzV2luZG93cywgb3NUeXBlIH0gZnJvbSBcIi4uL191dGlsL29zLnRzXCI7XG5cbmNvbnN0IGZvcndhcmRTbGFzaFJlZ0V4ID0gL1xcLy9nO1xuY29uc3QgcGVyY2VudFJlZ0V4ID0gLyUvZztcbmNvbnN0IGJhY2tzbGFzaFJlZ0V4ID0gL1xcXFwvZztcbmNvbnN0IG5ld2xpbmVSZWdFeCA9IC9cXG4vZztcbmNvbnN0IGNhcnJpYWdlUmV0dXJuUmVnRXggPSAvXFxyL2c7XG5jb25zdCB0YWJSZWdFeCA9IC9cXHQvZztcblxuY29uc3QgX3VybCA9IFVSTDtcbmV4cG9ydCB7IF91cmwgYXMgVVJMIH07XG5cbi8qKlxuICogVGhlIFVSTCBvYmplY3QgaGFzIGJvdGggYSBgdG9TdHJpbmcoKWAgbWV0aG9kIGFuZCBgaHJlZmAgcHJvcGVydHkgdGhhdCByZXR1cm4gc3RyaW5nIHNlcmlhbGl6YXRpb25zIG9mIHRoZSBVUkwuXG4gKiBUaGVzZSBhcmUgbm90LCBob3dldmVyLCBjdXN0b21pemFibGUgaW4gYW55IHdheS5cbiAqIFRoaXMgbWV0aG9kIGFsbG93cyBmb3IgYmFzaWMgY3VzdG9taXphdGlvbiBvZiB0aGUgb3V0cHV0LlxuICogQHNlZSBUZXN0ZWQgaW4gYHBhcmFsbGVsL3Rlc3QtdXJsLWZvcm1hdC13aGF0d2cuanNgLlxuICogQHBhcmFtIHVybE9iamVjdFxuICogQHBhcmFtIG9wdGlvbnNcbiAqIEBwYXJhbSBvcHRpb25zLmF1dGggYHRydWVgIGlmIHRoZSBzZXJpYWxpemVkIFVSTCBzdHJpbmcgc2hvdWxkIGluY2x1ZGUgdGhlIHVzZXJuYW1lIGFuZCBwYXNzd29yZCwgYGZhbHNlYCBvdGhlcndpc2UuICoqRGVmYXVsdCoqOiBgdHJ1ZWAuXG4gKiBAcGFyYW0gb3B0aW9ucy5mcmFnbWVudCBgdHJ1ZWAgaWYgdGhlIHNlcmlhbGl6ZWQgVVJMIHN0cmluZyBzaG91bGQgaW5jbHVkZSB0aGUgZnJhZ21lbnQsIGBmYWxzZWAgb3RoZXJ3aXNlLiAqKkRlZmF1bHQqKjogYHRydWVgLlxuICogQHBhcmFtIG9wdGlvbnMuc2VhcmNoIGB0cnVlYCBpZiB0aGUgc2VyaWFsaXplZCBVUkwgc3RyaW5nIHNob3VsZCBpbmNsdWRlIHRoZSBzZWFyY2ggcXVlcnksICoqRGVmYXVsdCoqOiBgdHJ1ZWAuXG4gKiBAcGFyYW0gb3B0aW9ucy51bmljb2RlIGB0cnVlYCBpZiBVbmljb2RlIGNoYXJhY3RlcnMgYXBwZWFyaW5nIGluIHRoZSBob3N0IGNvbXBvbmVudCBvZiB0aGUgVVJMIHN0cmluZyBzaG91bGQgYmUgZW5jb2RlZCBkaXJlY3RseSBhcyBvcHBvc2VkIHRvIGJlaW5nIFB1bnljb2RlIGVuY29kZWQuICoqRGVmYXVsdCoqOiBgZmFsc2VgLlxuICogQHJldHVybnMgYSBjdXN0b21pemFibGUgc2VyaWFsaXphdGlvbiBvZiBhIFVSTCBgU3RyaW5nYCByZXByZXNlbnRhdGlvbiBvZiBhIGBXSEFUV0cgVVJMYCBvYmplY3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXQoXG4gIHVybE9iamVjdDogVVJMLFxuICBvcHRpb25zPzoge1xuICAgIGF1dGg6IGJvb2xlYW47XG4gICAgZnJhZ21lbnQ6IGJvb2xlYW47XG4gICAgc2VhcmNoOiBib29sZWFuO1xuICAgIHVuaWNvZGU6IGJvb2xlYW47XG4gIH0sXG4pOiBzdHJpbmcge1xuICBpZiAob3B0aW9ucykge1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJvYmplY3RcIikge1xuICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKFwib3B0aW9uc1wiLCBcIm9iamVjdFwiLCBvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICBvcHRpb25zID0ge1xuICAgIGF1dGg6IHRydWUsXG4gICAgZnJhZ21lbnQ6IHRydWUsXG4gICAgc2VhcmNoOiB0cnVlLFxuICAgIHVuaWNvZGU6IGZhbHNlLFxuICAgIC4uLm9wdGlvbnMsXG4gIH07XG5cbiAgbGV0IHJldCA9IHVybE9iamVjdC5wcm90b2NvbDtcbiAgaWYgKHVybE9iamVjdC5ob3N0ICE9PSBudWxsKSB7XG4gICAgcmV0ICs9IFwiLy9cIjtcbiAgICBjb25zdCBoYXNVc2VybmFtZSA9IHVybE9iamVjdC51c2VybmFtZSAhPT0gXCJcIjtcbiAgICBjb25zdCBoYXNQYXNzd29yZCA9IHVybE9iamVjdC5wYXNzd29yZCAhPT0gXCJcIjtcbiAgICBpZiAob3B0aW9ucy5hdXRoICYmIChoYXNVc2VybmFtZSB8fCBoYXNQYXNzd29yZCkpIHtcbiAgICAgIGlmIChoYXNVc2VybmFtZSkge1xuICAgICAgICByZXQgKz0gdXJsT2JqZWN0LnVzZXJuYW1lO1xuICAgICAgfVxuICAgICAgaWYgKGhhc1Bhc3N3b3JkKSB7XG4gICAgICAgIHJldCArPSBgOiR7dXJsT2JqZWN0LnBhc3N3b3JkfWA7XG4gICAgICB9XG4gICAgICByZXQgKz0gXCJAXCI7XG4gICAgfVxuICAgIC8vIFRPRE8od2FmdXdmdTEzKTogU3VwcG9ydCB1bmljb2RlIG9wdGlvblxuICAgIC8vIHJldCArPSBvcHRpb25zLnVuaWNvZGUgP1xuICAgIC8vICAgZG9tYWluVG9Vbmljb2RlKHVybE9iamVjdC5ob3N0KSA6IHVybE9iamVjdC5ob3N0O1xuICAgIHJldCArPSB1cmxPYmplY3QuaG9zdDtcbiAgICBpZiAodXJsT2JqZWN0LnBvcnQpIHtcbiAgICAgIHJldCArPSBgOiR7dXJsT2JqZWN0LnBvcnR9YDtcbiAgICB9XG4gIH1cblxuICByZXQgKz0gdXJsT2JqZWN0LnBhdGhuYW1lO1xuXG4gIGlmIChvcHRpb25zLnNlYXJjaCkge1xuICAgIHJldCArPSB1cmxPYmplY3Quc2VhcmNoO1xuICB9XG4gIGlmIChvcHRpb25zLmZyYWdtZW50KSB7XG4gICAgcmV0ICs9IHVybE9iamVjdC5oYXNoO1xuICB9XG5cbiAgcmV0dXJuIHJldDtcbn1cblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhlIGNvcnJlY3QgZGVjb2RpbmdzIG9mIHBlcmNlbnQtZW5jb2RlZCBjaGFyYWN0ZXJzIGFzIHdlbGwgYXMgZW5zdXJpbmcgYSBjcm9zcy1wbGF0Zm9ybSB2YWxpZCBhYnNvbHV0ZSBwYXRoIHN0cmluZy5cbiAqIEBzZWUgVGVzdGVkIGluIGBwYXJhbGxlbC90ZXN0LWZpbGV1cmx0b3BhdGguanNgLlxuICogQHBhcmFtIHBhdGggVGhlIGZpbGUgVVJMIHN0cmluZyBvciBVUkwgb2JqZWN0IHRvIGNvbnZlcnQgdG8gYSBwYXRoLlxuICogQHJldHVybnMgVGhlIGZ1bGx5LXJlc29sdmVkIHBsYXRmb3JtLXNwZWNpZmljIE5vZGUuanMgZmlsZSBwYXRoLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZmlsZVVSTFRvUGF0aChwYXRoOiBzdHJpbmcgfCBVUkwpOiBzdHJpbmcge1xuICBpZiAodHlwZW9mIHBhdGggPT09IFwic3RyaW5nXCIpIHBhdGggPSBuZXcgVVJMKHBhdGgpO1xuICBlbHNlIGlmICghKHBhdGggaW5zdGFuY2VvZiBVUkwpKSB7XG4gICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKFwicGF0aFwiLCBbXCJzdHJpbmdcIiwgXCJVUkxcIl0sIHBhdGgpO1xuICB9XG4gIGlmIChwYXRoLnByb3RvY29sICE9PSBcImZpbGU6XCIpIHtcbiAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfVVJMX1NDSEVNRShcImZpbGVcIik7XG4gIH1cbiAgcmV0dXJuIGlzV2luZG93cyA/IGdldFBhdGhGcm9tVVJMV2luKHBhdGgpIDogZ2V0UGF0aEZyb21VUkxQb3NpeChwYXRoKTtcbn1cblxuZnVuY3Rpb24gZ2V0UGF0aEZyb21VUkxXaW4odXJsOiBVUkwpOiBzdHJpbmcge1xuICBjb25zdCBob3N0bmFtZSA9IHVybC5ob3N0bmFtZTtcbiAgbGV0IHBhdGhuYW1lID0gdXJsLnBhdGhuYW1lO1xuICBmb3IgKGxldCBuID0gMDsgbiA8IHBhdGhuYW1lLmxlbmd0aDsgbisrKSB7XG4gICAgaWYgKHBhdGhuYW1lW25dID09PSBcIiVcIikge1xuICAgICAgY29uc3QgdGhpcmQgPSBwYXRobmFtZS5jb2RlUG9pbnRBdChuICsgMikhIHwgMHgyMDtcbiAgICAgIGlmIChcbiAgICAgICAgKHBhdGhuYW1lW24gKyAxXSA9PT0gXCIyXCIgJiYgdGhpcmQgPT09IDEwMikgfHwgLy8gMmYgMkYgL1xuICAgICAgICAocGF0aG5hbWVbbiArIDFdID09PSBcIjVcIiAmJiB0aGlyZCA9PT0gOTkpIC8vIDVjIDVDIFxcXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0ZJTEVfVVJMX1BBVEgoXG4gICAgICAgICAgXCJtdXN0IG5vdCBpbmNsdWRlIGVuY29kZWQgXFxcXCBvciAvIGNoYXJhY3RlcnNcIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwYXRobmFtZSA9IHBhdGhuYW1lLnJlcGxhY2UoZm9yd2FyZFNsYXNoUmVnRXgsIFwiXFxcXFwiKTtcbiAgcGF0aG5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQocGF0aG5hbWUpO1xuICBpZiAoaG9zdG5hbWUgIT09IFwiXCIpIHtcbiAgICAvLyBUT0RPKGJhcnRsb21pZWp1KTogYWRkIHN1cHBvcnQgZm9yIHB1bnljb2RlIGVuY29kaW5nc1xuICAgIHJldHVybiBgXFxcXFxcXFwke2hvc3RuYW1lfSR7cGF0aG5hbWV9YDtcbiAgfSBlbHNlIHtcbiAgICAvLyBPdGhlcndpc2UsIGl0J3MgYSBsb2NhbCBwYXRoIHRoYXQgcmVxdWlyZXMgYSBkcml2ZSBsZXR0ZXJcbiAgICBjb25zdCBsZXR0ZXIgPSBwYXRobmFtZS5jb2RlUG9pbnRBdCgxKSEgfCAweDIwO1xuICAgIGNvbnN0IHNlcCA9IHBhdGhuYW1lWzJdO1xuICAgIGlmIChcbiAgICAgIGxldHRlciA8IENIQVJfTE9XRVJDQVNFX0EgfHxcbiAgICAgIGxldHRlciA+IENIQVJfTE9XRVJDQVNFX1ogfHwgLy8gYS4ueiBBLi5aXG4gICAgICBzZXAgIT09IFwiOlwiXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfRklMRV9VUkxfUEFUSChcIm11c3QgYmUgYWJzb2x1dGVcIik7XG4gICAgfVxuICAgIHJldHVybiBwYXRobmFtZS5zbGljZSgxKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRQYXRoRnJvbVVSTFBvc2l4KHVybDogVVJMKTogc3RyaW5nIHtcbiAgaWYgKHVybC5ob3N0bmFtZSAhPT0gXCJcIikge1xuICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9GSUxFX1VSTF9IT1NUKG9zVHlwZSk7XG4gIH1cbiAgY29uc3QgcGF0aG5hbWUgPSB1cmwucGF0aG5hbWU7XG4gIGZvciAobGV0IG4gPSAwOyBuIDwgcGF0aG5hbWUubGVuZ3RoOyBuKyspIHtcbiAgICBpZiAocGF0aG5hbWVbbl0gPT09IFwiJVwiKSB7XG4gICAgICBjb25zdCB0aGlyZCA9IHBhdGhuYW1lLmNvZGVQb2ludEF0KG4gKyAyKSEgfCAweDIwO1xuICAgICAgaWYgKHBhdGhuYW1lW24gKyAxXSA9PT0gXCIyXCIgJiYgdGhpcmQgPT09IDEwMikge1xuICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfRklMRV9VUkxfUEFUSChcbiAgICAgICAgICBcIm11c3Qgbm90IGluY2x1ZGUgZW5jb2RlZCAvIGNoYXJhY3RlcnNcIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChwYXRobmFtZSk7XG59XG5cbi8qKlxuICogIFRoZSBmb2xsb3dpbmcgY2hhcmFjdGVycyBhcmUgcGVyY2VudC1lbmNvZGVkIHdoZW4gY29udmVydGluZyBmcm9tIGZpbGUgcGF0aFxuICogIHRvIFVSTDpcbiAqICAtICU6IFRoZSBwZXJjZW50IGNoYXJhY3RlciBpcyB0aGUgb25seSBjaGFyYWN0ZXIgbm90IGVuY29kZWQgYnkgdGhlXG4gKiAgICAgICBgcGF0aG5hbWVgIHNldHRlci5cbiAqICAtIFxcOiBCYWNrc2xhc2ggaXMgZW5jb2RlZCBvbiBub24td2luZG93cyBwbGF0Zm9ybXMgc2luY2UgaXQncyBhIHZhbGlkXG4gKiAgICAgICBjaGFyYWN0ZXIgYnV0IHRoZSBgcGF0aG5hbWVgIHNldHRlcnMgcmVwbGFjZXMgaXQgYnkgYSBmb3J3YXJkIHNsYXNoLlxuICogIC0gTEY6IFRoZSBuZXdsaW5lIGNoYXJhY3RlciBpcyBzdHJpcHBlZCBvdXQgYnkgdGhlIGBwYXRobmFtZWAgc2V0dGVyLlxuICogICAgICAgIChTZWUgd2hhdHdnL3VybCM0MTkpXG4gKiAgLSBDUjogVGhlIGNhcnJpYWdlIHJldHVybiBjaGFyYWN0ZXIgaXMgYWxzbyBzdHJpcHBlZCBvdXQgYnkgdGhlIGBwYXRobmFtZWBcbiAqICAgICAgICBzZXR0ZXIuXG4gKiAgLSBUQUI6IFRoZSB0YWIgY2hhcmFjdGVyIGlzIGFsc28gc3RyaXBwZWQgb3V0IGJ5IHRoZSBgcGF0aG5hbWVgIHNldHRlci5cbiAqL1xuZnVuY3Rpb24gZW5jb2RlUGF0aENoYXJzKGZpbGVwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICBpZiAoZmlsZXBhdGguaW5jbHVkZXMoXCIlXCIpKSB7XG4gICAgZmlsZXBhdGggPSBmaWxlcGF0aC5yZXBsYWNlKHBlcmNlbnRSZWdFeCwgXCIlMjVcIik7XG4gIH1cbiAgLy8gSW4gcG9zaXgsIGJhY2tzbGFzaCBpcyBhIHZhbGlkIGNoYXJhY3RlciBpbiBwYXRoczpcbiAgaWYgKCFpc1dpbmRvd3MgJiYgZmlsZXBhdGguaW5jbHVkZXMoXCJcXFxcXCIpKSB7XG4gICAgZmlsZXBhdGggPSBmaWxlcGF0aC5yZXBsYWNlKGJhY2tzbGFzaFJlZ0V4LCBcIiU1Q1wiKTtcbiAgfVxuICBpZiAoZmlsZXBhdGguaW5jbHVkZXMoXCJcXG5cIikpIHtcbiAgICBmaWxlcGF0aCA9IGZpbGVwYXRoLnJlcGxhY2UobmV3bGluZVJlZ0V4LCBcIiUwQVwiKTtcbiAgfVxuICBpZiAoZmlsZXBhdGguaW5jbHVkZXMoXCJcXHJcIikpIHtcbiAgICBmaWxlcGF0aCA9IGZpbGVwYXRoLnJlcGxhY2UoY2FycmlhZ2VSZXR1cm5SZWdFeCwgXCIlMERcIik7XG4gIH1cbiAgaWYgKGZpbGVwYXRoLmluY2x1ZGVzKFwiXFx0XCIpKSB7XG4gICAgZmlsZXBhdGggPSBmaWxlcGF0aC5yZXBsYWNlKHRhYlJlZ0V4LCBcIiUwOVwiKTtcbiAgfVxuICByZXR1cm4gZmlsZXBhdGg7XG59XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgYGZpbGVwYXRoYCBpcyByZXNvbHZlZCBhYnNvbHV0ZWx5LCBhbmQgdGhhdCB0aGUgVVJMIGNvbnRyb2wgY2hhcmFjdGVycyBhcmUgY29ycmVjdGx5IGVuY29kZWQgd2hlbiBjb252ZXJ0aW5nIGludG8gYSBGaWxlIFVSTC5cbiAqIEBzZWUgVGVzdGVkIGluIGBwYXJhbGxlbC90ZXN0LXVybC1wYXRodG9maWxldXJsLmpzYC5cbiAqIEBwYXJhbSBmaWxlcGF0aCBUaGUgZmlsZSBwYXRoIHN0cmluZyB0byBjb252ZXJ0IHRvIGEgZmlsZSBVUkwuXG4gKiBAcmV0dXJucyBUaGUgZmlsZSBVUkwgb2JqZWN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gcGF0aFRvRmlsZVVSTChmaWxlcGF0aDogc3RyaW5nKTogVVJMIHtcbiAgY29uc3Qgb3V0VVJMID0gbmV3IFVSTChcImZpbGU6Ly9cIik7XG4gIGlmIChpc1dpbmRvd3MgJiYgZmlsZXBhdGguc3RhcnRzV2l0aChcIlxcXFxcXFxcXCIpKSB7XG4gICAgLy8gVU5DIHBhdGggZm9ybWF0OiBcXFxcc2VydmVyXFxzaGFyZVxccmVzb3VyY2VcbiAgICBjb25zdCBwYXRocyA9IGZpbGVwYXRoLnNwbGl0KFwiXFxcXFwiKTtcbiAgICBpZiAocGF0aHMubGVuZ3RoIDw9IDMpIHtcbiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVkFMVUUoXG4gICAgICAgIFwiZmlsZXBhdGhcIixcbiAgICAgICAgZmlsZXBhdGgsXG4gICAgICAgIFwiTWlzc2luZyBVTkMgcmVzb3VyY2UgcGF0aFwiLFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgaG9zdG5hbWUgPSBwYXRoc1syXTtcbiAgICBpZiAoaG9zdG5hbWUubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1ZBTFVFKFxuICAgICAgICBcImZpbGVwYXRoXCIsXG4gICAgICAgIGZpbGVwYXRoLFxuICAgICAgICBcIkVtcHR5IFVOQyBzZXJ2ZXJuYW1lXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFRPRE8od2FmdXdhZnUxMyk6IFRvIGJlIGBvdXRVUkwuaG9zdG5hbWUgPSBkb21haW5Ub0FTQ0lJKGhvc3RuYW1lKWAgb25jZSBgZG9tYWluVG9BU0NJSWAgYXJlIGltcGxlbWVudGVkXG4gICAgb3V0VVJMLmhvc3RuYW1lID0gaG9zdG5hbWU7XG4gICAgb3V0VVJMLnBhdGhuYW1lID0gZW5jb2RlUGF0aENoYXJzKFxuICAgICAgcGF0aHMuc2xpY2UoMykuam9pbihcIi9cIiksXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgcmVzb2x2ZWQgPSBwYXRoLnJlc29sdmUoZmlsZXBhdGgpO1xuICAgIC8vIHBhdGgucmVzb2x2ZSBzdHJpcHMgdHJhaWxpbmcgc2xhc2hlcyBzbyB3ZSBtdXN0IGFkZCB0aGVtIGJhY2tcbiAgICBjb25zdCBmaWxlUGF0aExhc3QgPSBmaWxlcGF0aC5jaGFyQ29kZUF0KGZpbGVwYXRoLmxlbmd0aCAtIDEpO1xuICAgIGlmIChcbiAgICAgIChmaWxlUGF0aExhc3QgPT09IENIQVJfRk9SV0FSRF9TTEFTSCB8fFxuICAgICAgICAoaXNXaW5kb3dzICYmIGZpbGVQYXRoTGFzdCA9PT0gQ0hBUl9CQUNLV0FSRF9TTEFTSCkpICYmXG4gICAgICByZXNvbHZlZFtyZXNvbHZlZC5sZW5ndGggLSAxXSAhPT0gcGF0aC5zZXBcbiAgICApIHtcbiAgICAgIHJlc29sdmVkICs9IFwiL1wiO1xuICAgIH1cblxuICAgIG91dFVSTC5wYXRobmFtZSA9IGVuY29kZVBhdGhDaGFycyhyZXNvbHZlZCk7XG4gIH1cbiAgcmV0dXJuIG91dFVSTDtcbn1cblxuaW50ZXJmYWNlIEh0dHBPcHRpb25zIHtcbiAgcHJvdG9jb2w6IHN0cmluZztcbiAgaG9zdG5hbWU6IHN0cmluZztcbiAgaGFzaDogc3RyaW5nO1xuICBzZWFyY2g6IHN0cmluZztcbiAgcGF0aG5hbWU6IHN0cmluZztcbiAgcGF0aDogc3RyaW5nO1xuICBocmVmOiBzdHJpbmc7XG4gIHBvcnQ/OiBudW1iZXI7XG4gIGF1dGg/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogVGhpcyB1dGlsaXR5IGZ1bmN0aW9uIGNvbnZlcnRzIGEgVVJMIG9iamVjdCBpbnRvIGFuIG9yZGluYXJ5IG9wdGlvbnMgb2JqZWN0IGFzIGV4cGVjdGVkIGJ5IHRoZSBgaHR0cC5yZXF1ZXN0KClgIGFuZCBgaHR0cHMucmVxdWVzdCgpYCBBUElzLlxuICogQHNlZSBUZXN0ZWQgaW4gYHBhcmFsbGVsL3Rlc3QtdXJsLXVybHRvb3B0aW9ucy5qc2AuXG4gKiBAcGFyYW0gdXJsIFRoZSBgV0hBVFdHIFVSTGAgb2JqZWN0IHRvIGNvbnZlcnQgdG8gYW4gb3B0aW9ucyBvYmplY3QuXG4gKiBAcmV0dXJucyBIdHRwT3B0aW9uc1xuICogQHJldHVybnMgSHR0cE9wdGlvbnMucHJvdG9jb2wgUHJvdG9jb2wgdG8gdXNlLlxuICogQHJldHVybnMgSHR0cE9wdGlvbnMuaG9zdG5hbWUgQSBkb21haW4gbmFtZSBvciBJUCBhZGRyZXNzIG9mIHRoZSBzZXJ2ZXIgdG8gaXNzdWUgdGhlIHJlcXVlc3QgdG8uXG4gKiBAcmV0dXJucyBIdHRwT3B0aW9ucy5oYXNoIFRoZSBmcmFnbWVudCBwb3J0aW9uIG9mIHRoZSBVUkwuXG4gKiBAcmV0dXJucyBIdHRwT3B0aW9ucy5zZWFyY2ggVGhlIHNlcmlhbGl6ZWQgcXVlcnkgcG9ydGlvbiBvZiB0aGUgVVJMLlxuICogQHJldHVybnMgSHR0cE9wdGlvbnMucGF0aG5hbWUgVGhlIHBhdGggcG9ydGlvbiBvZiB0aGUgVVJMLlxuICogQHJldHVybnMgSHR0cE9wdGlvbnMucGF0aCBSZXF1ZXN0IHBhdGguIFNob3VsZCBpbmNsdWRlIHF1ZXJ5IHN0cmluZyBpZiBhbnkuIEUuRy4gYCcvaW5kZXguaHRtbD9wYWdlPTEyJ2AuIEFuIGV4Y2VwdGlvbiBpcyB0aHJvd24gd2hlbiB0aGUgcmVxdWVzdCBwYXRoIGNvbnRhaW5zIGlsbGVnYWwgY2hhcmFjdGVycy4gQ3VycmVudGx5LCBvbmx5IHNwYWNlcyBhcmUgcmVqZWN0ZWQgYnV0IHRoYXQgbWF5IGNoYW5nZSBpbiB0aGUgZnV0dXJlLlxuICogQHJldHVybnMgSHR0cE9wdGlvbnMuaHJlZiBUaGUgc2VyaWFsaXplZCBVUkwuXG4gKiBAcmV0dXJucyBIdHRwT3B0aW9ucy5wb3J0IFBvcnQgb2YgcmVtb3RlIHNlcnZlci5cbiAqIEByZXR1cm5zIEh0dHBPcHRpb25zLmF1dGggQmFzaWMgYXV0aGVudGljYXRpb24gaS5lLiBgJ3VzZXI6cGFzc3dvcmQnYCB0byBjb21wdXRlIGFuIEF1dGhvcml6YXRpb24gaGVhZGVyLlxuICovXG5mdW5jdGlvbiB1cmxUb0h0dHBPcHRpb25zKHVybDogVVJMKTogSHR0cE9wdGlvbnMge1xuICBjb25zdCBvcHRpb25zOiBIdHRwT3B0aW9ucyA9IHtcbiAgICBwcm90b2NvbDogdXJsLnByb3RvY29sLFxuICAgIGhvc3RuYW1lOiB0eXBlb2YgdXJsLmhvc3RuYW1lID09PSBcInN0cmluZ1wiICYmXG4gICAgICAgIHVybC5ob3N0bmFtZS5zdGFydHNXaXRoKFwiW1wiKVxuICAgICAgPyB1cmwuaG9zdG5hbWUuc2xpY2UoMSwgLTEpXG4gICAgICA6IHVybC5ob3N0bmFtZSxcbiAgICBoYXNoOiB1cmwuaGFzaCxcbiAgICBzZWFyY2g6IHVybC5zZWFyY2gsXG4gICAgcGF0aG5hbWU6IHVybC5wYXRobmFtZSxcbiAgICBwYXRoOiBgJHt1cmwucGF0aG5hbWUgfHwgXCJcIn0ke3VybC5zZWFyY2ggfHwgXCJcIn1gLFxuICAgIGhyZWY6IHVybC5ocmVmLFxuICB9O1xuICBpZiAodXJsLnBvcnQgIT09IFwiXCIpIHtcbiAgICBvcHRpb25zLnBvcnQgPSBOdW1iZXIodXJsLnBvcnQpO1xuICB9XG4gIGlmICh1cmwudXNlcm5hbWUgfHwgdXJsLnBhc3N3b3JkKSB7XG4gICAgb3B0aW9ucy5hdXRoID0gYCR7ZGVjb2RlVVJJQ29tcG9uZW50KHVybC51c2VybmFtZSl9OiR7XG4gICAgICBkZWNvZGVVUklDb21wb25lbnQodXJsLnBhc3N3b3JkKVxuICAgIH1gO1xuICB9XG4gIHJldHVybiBvcHRpb25zO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGZvcm1hdCxcbiAgZmlsZVVSTFRvUGF0aCxcbiAgcGF0aFRvRmlsZVVSTCxcbiAgdXJsVG9IdHRwT3B0aW9ucyxcbiAgVVJMLFxufTtcbiJdfQ==