import { bgGreen, bgWhite, } from "https://deno.land/std@0.74.0/fmt/colors.ts";
const isTTY = Deno.isatty(Deno.stdout.rid);
const isWindow = Deno.build.os === "windows";
var Direction;
(function (Direction) {
    Direction[Direction["left"] = 0] = "left";
    Direction[Direction["right"] = 1] = "right";
    Direction[Direction["all"] = 2] = "all";
})(Direction || (Direction = {}));
export default class ProgressBar {
    title;
    total;
    width;
    complete;
    preciseBar;
    incomplete;
    clear;
    interval;
    display;
    isCompleted = false;
    lastStr = "";
    start = Date.now();
    time;
    lastRender = 0;
    encoder = new TextEncoder();
    constructor({ title = "", total, width = 50, complete = bgGreen(" "), preciseBar = [], incomplete = bgWhite(" "), clear = false, interval, display, } = {}) {
        this.title = title;
        this.total = total;
        this.width = width;
        this.complete = complete;
        this.preciseBar = preciseBar.concat(complete);
        this.incomplete = incomplete;
        this.clear = clear;
        this.interval = interval ?? 16;
        this.display = display ?? ":title :percent :bar :time :completed/:total";
    }
    render(completed, options = {}) {
        if (!isTTY)
            return;
        completed = +completed;
        if (!Number.isInteger(completed)) {
            throw new Error(`completed must be 'number'`);
        }
        if (completed < 0) {
            throw new Error(`completed must greater than or equal to 0`);
        }
        const total = options.total ?? this.total;
        if (total === undefined)
            throw new Error(`total required`);
        if (!Number.isInteger(total))
            throw new Error(`total must be 'number'`);
        if (this.isCompleted)
            console.warn("Called after the end");
        const now = Date.now();
        const ms = now - this.lastRender;
        if (ms < this.interval && completed < total)
            return;
        this.lastRender = now;
        this.time = ((now - this.start) / 1000).toFixed(1) + "s";
        const percent = ((completed / total) * 100).toFixed(2) + "%";
        let str = this.display
            .replace(":title", options.title ?? this.title)
            .replace(":time", this.time)
            .replace(":percent", percent)
            .replace(":completed", completed + "")
            .replace(":total", total + "");
        let availableSpace = Math.max(0, this.ttyColumns - str.replace(":bar", "").length);
        if (availableSpace && isWindow)
            availableSpace -= 1;
        const width = Math.min(this.width, availableSpace);
        const finished = completed >= total;
        const preciseBar = options.preciseBar ?? this.preciseBar;
        const precision = preciseBar.length > 1;
        const completeLength = width * completed / total;
        const roundedCompleteLength = Math.floor(completeLength);
        let precise = "";
        if (precision) {
            const preciseLength = completeLength - roundedCompleteLength;
            precise = finished
                ? ""
                : preciseBar[Math.floor(preciseBar.length * preciseLength)];
        }
        const complete = new Array(roundedCompleteLength).fill(options.complete ?? this.complete).join("");
        const incomplete = new Array(Math.max(width - roundedCompleteLength - (precision ? 1 : 0), 0)).fill(options.incomplete ?? this.incomplete).join("");
        str = str.replace(":bar", complete + precise + incomplete);
        if (str !== this.lastStr) {
            this.write(str);
            this.lastStr = str;
        }
        if (finished)
            this.end();
    }
    end() {
        this.isCompleted = true;
        if (this.clear) {
            this.stdoutWrite("\r");
            this.clearLine();
        }
        else {
            this.breakLine();
        }
        this.showCursor();
    }
    console(message) {
        this.clearLine();
        this.write(`${message}`);
        this.breakLine();
        this.write(this.lastStr);
    }
    write(msg) {
        msg = `\r${msg}\x1b[?25l`;
        this.stdoutWrite(msg);
    }
    get ttyColumns() {
        return 100;
    }
    breakLine() {
        this.stdoutWrite("\r\n");
    }
    stdoutWrite(msg) {
        Deno.writeAllSync(Deno.stdout, this.encoder.encode(msg));
    }
    clearLine(direction = Direction.all) {
        switch (direction) {
            case Direction.all:
                this.stdoutWrite("\x1b[2K");
                break;
            case Direction.left:
                this.stdoutWrite("\x1b[1K");
                break;
            case Direction.right:
                this.stdoutWrite("\x1b[0K");
                break;
        }
    }
    showCursor() {
        this.stdoutWrite("\x1b[?25h");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxPQUFPLEVBQ1AsT0FBTyxHQUNSLE1BQU0sNENBQTRDLENBQUM7QUFFcEQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQztBQUU3QyxJQUFXLFNBSVY7QUFKRCxXQUFXLFNBQVM7SUFDbEIseUNBQUksQ0FBQTtJQUNKLDJDQUFLLENBQUE7SUFDTCx1Q0FBRyxDQUFBO0FBQ0wsQ0FBQyxFQUpVLFNBQVMsS0FBVCxTQUFTLFFBSW5CO0FBc0JELE1BQU0sQ0FBQyxPQUFPLE9BQU8sV0FBVztJQUM5QixLQUFLLENBQVM7SUFDZCxLQUFLLENBQVU7SUFDZixLQUFLLENBQVM7SUFDZCxRQUFRLENBQVM7SUFDakIsVUFBVSxDQUFXO0lBQ3JCLFVBQVUsQ0FBUztJQUNuQixLQUFLLENBQVU7SUFDZixRQUFRLENBQVM7SUFDakIsT0FBTyxDQUFTO0lBRVIsV0FBVyxHQUFHLEtBQUssQ0FBQztJQUNwQixPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ2IsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNuQixJQUFJLENBQVU7SUFDZCxVQUFVLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFjcEMsWUFDRSxFQUNFLEtBQUssR0FBRyxFQUFFLEVBQ1YsS0FBSyxFQUNMLEtBQUssR0FBRyxFQUFFLEVBQ1YsUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFDdkIsVUFBVSxHQUFHLEVBQUUsRUFDZixVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUN6QixLQUFLLEdBQUcs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Q3hCLENBQUM7SUFFRCxJQUFZLFVBQVU7UUFDcEIsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRU8sU0FBUztRQUNmLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVPLFdBQVcsQ0FBQyxHQUFXO1FBQzdCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFTyxTQUFTLENBQUMsWUFBdUIsU0FBUyxDQUFDLEdBQUc7UUFDcEQsUUFBUSxTQUFTLEVBQUU7WUFDakIsS0FBSyxTQUFTLENBQUMsR0FBRztnQkFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDNUIsTUFBTTtZQUNSLEtBQUssU0FBUyxDQUFDLElBQUk7Z0JBQ2pCLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzVCLE1BQU07WUFDUixLQUFLLFNBQVMsQ0FBQyxLQUFLO2dCQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUM1QixNQUFNO1NBQ1Q7SUFDSCxDQUFDO0lBRU8sVUFBVTtRQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGJnR3JlZW4sXG4gIGJnV2hpdGUsXG59IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC9zdGRAMC43NC4wL2ZtdC9jb2xvcnMudHNcIjtcblxuY29uc3QgaXNUVFkgPSBEZW5vLmlzYXR0eShEZW5vLnN0ZG91dC5yaWQpO1xuY29uc3QgaXNXaW5kb3cgPSBEZW5vLmJ1aWxkLm9zID09PSBcIndpbmRvd3NcIjtcblxuY29uc3QgZW51bSBEaXJlY3Rpb24ge1xuICBsZWZ0LFxuICByaWdodCxcbiAgYWxsLFxufVxuXG5pbnRlcmZhY2UgY29uc3RydWN0b3JPcHRpb25zIHtcbiAgdGl0bGU/OiBzdHJpbmc7XG4gIHRvdGFsPzogbnVtYmVyO1xuICB3aWR0aD86IG51bWJlcjtcbiAgY29tcGxldGU/OiBzdHJpbmc7XG4gIHByZWNpc2VCYXI/OiBzdHJpbmdbXTtcbiAgaW5jb21wbGV0ZT86IHN0cmluZztcbiAgY2xlYXI/OiBib29sZWFuO1xuICBpbnRlcnZhbD86IG51bWJlcjtcbiAgZGlzcGxheT86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIHJlbmRlck9wdGlvbnMge1xuICB0aXRsZT86IHN0cmluZztcbiAgdG90YWw/OiBudW1iZXI7XG4gIGNvbXBsZXRlPzogc3RyaW5nO1xuICBwcmVjaXNlQmFyPzogc3RyaW5nW107XG4gIGluY29tcGxldGU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb2dyZXNzQmFyIHtcbiAgdGl0bGU6IHN0cmluZztcbiAgdG90YWw/OiBudW1iZXI7XG4gIHdpZHRoOiBudW1iZXI7XG4gIGNvbXBsZXRlOiBzdHJpbmc7XG4gIHByZWNpc2VCYXI6IHN0cmluZ1tdO1xuICBpbmNvbXBsZXRlOiBzdHJpbmc7XG4gIGNsZWFyOiBib29sZWFuO1xuICBpbnRlcnZhbDogbnVtYmVyO1xuICBkaXNwbGF5OiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBpc0NvbXBsZXRlZCA9IGZhbHNlO1xuICBwcml2YXRlIGxhc3RTdHIgPSBcIlwiO1xuICBwcml2YXRlIHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgcHJpdmF0ZSB0aW1lPzogc3RyaW5nO1xuICBwcml2YXRlIGxhc3RSZW5kZXIgPSAwO1xuICBwcml2YXRlIGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcblxuICAvKipcbiAgICogVGl0bGUsIHRvdGFsLCBjb21wbGV0ZSwgaW5jb21wbGV0ZSwgY2FuIGFsc28gYmUgc2V0IG9yIGNoYW5nZWQgaW4gdGhlIHJlbmRlciBtZXRob2QgXG4gICAqIFxuICAgKiBAcGFyYW0gdGl0bGUgUHJvZ3Jlc3MgYmFyIHRpdGxlLCBkZWZhdWx0OiAnJ1xuICAgKiBAcGFyYW0gdG90YWwgdG90YWwgbnVtYmVyIG9mIHRpY2tzIHRvIGNvbXBsZXRlLCBcbiAgICogQHBhcmFtIHdpZHRoIHRoZSBkaXNwbGF5ZWQgd2lkdGggb2YgdGhlIHByb2dyZXNzLCBkZWZhdWx0OiA1MFxuICAgKiBAcGFyYW0gY29tcGxldGUgY29tcGxldGlvbiBjaGFyYWN0ZXIsIGRlZmF1bHQ6IGNvbG9ycy5iZ0dyZWVuKCcgJyksIGNhbiB1c2UgYW55IHN0cmluZ1xuICAgKiBAcGFyYW0gaW5jb21wbGV0ZSBpbmNvbXBsZXRlIGNoYXJhY3RlciwgZGVmYXVsdDogY29sb3JzLmJnV2hpdGUoJyAnKSwgY2FuIHVzZSBhbnkgc3RyaW5nXG4gICAqIEBwYXJhbSBjbGVhciAgY2xlYXIgdGhlIGJhciBvbiBjb21wbGV0aW9uLCBkZWZhdWx0OiBmYWxzZVxuICAgKiBAcGFyYW0gaW50ZXJ2YWwgIG1pbmltdW0gdGltZSBiZXR3ZWVuIHVwZGF0ZXMgaW4gbWlsbGlzZWNvbmRzLCBkZWZhdWx0OiAxNlxuICAgKiBAcGFyYW0gZGlzcGxheSAgV2hhdCBpcyBkaXNwbGF5ZWQgYW5kIGRpc3BsYXkgb3JkZXIsIGRlZmF1bHQ6ICc6dGl0bGUgOnBlcmNlbnQgOmJhciA6dGltZSA6Y29tcGxldGVkLzp0b3RhbCdcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHtcbiAgICAgIHRpdGxlID0gXCJcIixcbiAgICAgIHRvdGFsLFxuICAgICAgd2lkdGggPSA1MCxcbiAgICAgIGNvbXBsZXRlID0gYmdHcmVlbihcIiBcIiksXG4gICAgICBwcmVjaXNlQmFyID0gW10sXG4gICAgICBpbmNvbXBsZXRlID0gYmdXaGl0ZShcIiBcIiksXG4gICAgICBjbGVhciA9IGZhbHNlLFxuICAgICAgaW50ZXJ2YWwsXG4gICAgICBkaXNwbGF5LFxuICAgIH06IGNvbnN0cnVjdG9yT3B0aW9ucyA9IHt9LFxuICApIHtcbiAgICB0aGlzLnRpdGxlID0gdGl0bGU7XG4gICAgdGhpcy50b3RhbCA9IHRvdGFsO1xuICAgIHRoaXMud2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLmNvbXBsZXRlID0gY29tcGxldGU7XG4gICAgdGhpcy5wcmVjaXNlQmFyID0gcHJlY2lzZUJhci5jb25jYXQoY29tcGxldGUpO1xuICAgIHRoaXMuaW5jb21wbGV0ZSA9IGluY29tcGxldGU7XG4gICAgdGhpcy5jbGVhciA9IGNsZWFyO1xuICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbCA/PyAxNjtcbiAgICB0aGlzLmRpc3BsYXkgPSBkaXNwbGF5ID8/IFwiOnRpdGxlIDpwZXJjZW50IDpiYXIgOnRpbWUgOmNvbXBsZXRlZC86dG90YWxcIjtcbiAgfVxuXG4gIC8qKlxuICAgKiBcInJlbmRlclwiIHRoZSBwcm9ncmVzcyBiYXJcbiAgICogXG4gICAqIC0gYGNvbXBsZXRlZGAgLSBDb21wbGV0ZWQgdmFsdWVcbiAgICogLSBgb3B0aW9uc2AgLSBPcHRpb25hbCBwYXJhbWV0ZXJzXG4gICAqICAgLSBgdGl0bGVgIC0gUHJvZ3Jlc3MgYmFyIHRpdGxlXG4gICAqICAgLSBgdG90YWxgIC0gdG90YWwgbnVtYmVyIG9mIHRpY2tzIHRvIGNvbXBsZXRlXG4gICAqICAgLSBgY29tcGxldGVgIC0gY29tcGxldGlvbiBjaGFyYWN0ZXIsIElmIHlvdSB3YW50IHRvIGNoYW5nZSBhdCBhIGNlcnRhaW4gbW9tZW50LiBGb3IgZXhhbXBsZSwgaXQgdHVybnMgcmVkIGF0IDIwJVxuICAgKiAgIC0gYGluY29tcGxldGVgIC0gaW5jb21wbGV0ZSBjaGFyYWN0ZXIsIElmIHlvdSB3YW50IHRvIGNoYW5nZSBhdCBhIGNlcnRhaW4gbW9tZW50LiBGb3IgZXhhbXBsZSwgaXQgdHVybnMgcmVkIGF0IDIwJVxuICAgKi9cbiAgcmVuZGVyKGNvbXBsZXRlZDogbnVtYmVyLCBvcHRpb25zOiByZW5kZXJPcHRpb25zID0ge30pOiB2b2lkIHtcbiAgICBpZiAoIWlzVFRZKSByZXR1cm47XG5cbiAgICBjb21wbGV0ZWQgPSArY29tcGxldGVkO1xuICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihjb21wbGV0ZWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGNvbXBsZXRlZCBtdXN0IGJlICdudW1iZXInYCk7XG4gICAgfVxuICAgIGlmIChjb21wbGV0ZWQgPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGNvbXBsZXRlZCBtdXN0IGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byAwYCk7XG4gICAgfVxuXG4gICAgY29uc3QgdG90YWwgPSBvcHRpb25zLnRvdGFsID8/IHRoaXMudG90YWw7XG4gICAgaWYgKHRvdGFsID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcihgdG90YWwgcmVxdWlyZWRgKTtcbiAgICBpZiAoIU51bWJlci5pc0ludGVnZXIodG90YWwpKSB0aHJvdyBuZXcgRXJyb3IoYHRvdGFsIG11c3QgYmUgJ251bWJlcidgKTtcblxuICAgIGlmICh0aGlzLmlzQ29tcGxldGVkKSBjb25zb2xlLndhcm4oXCJDYWxsZWQgYWZ0ZXIgdGhlIGVuZFwiKTtcblxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgbXMgPSBub3cgLSB0aGlzLmxhc3RSZW5kZXI7XG4gICAgaWYgKG1zIDwgdGhpcy5pbnRlcnZhbCEgJiYgY29tcGxldGVkIDwgdG90YWwpIHJldHVybjtcblxuICAgIHRoaXMubGFzdFJlbmRlciA9IG5vdztcbiAgICB0aGlzLnRpbWUgPSAoKG5vdyAtIHRoaXMuc3RhcnQpIC8gMTAwMCkudG9GaXhlZCgxKSArIFwic1wiO1xuXG4gICAgY29uc3QgcGVyY2VudCA9ICgoY29tcGxldGVkIC8gdG90YWwpICogMTAwKS50b0ZpeGVkKDIpICsgXCIlXCI7XG5cbiAgICAvLyA6dGl0bGUgOnBlcmNlbnQgOmJhciA6dGltZSA6Y29tcGxldGVkLzp0b3RhbFxuICAgIGxldCBzdHIgPSB0aGlzLmRpc3BsYXlcbiAgICAgIC5yZXBsYWNlKFwiOnRpdGxlXCIsIG9wdGlvbnMudGl0bGUgPz8gdGhpcy50aXRsZSlcbiAgICAgIC5yZXBsYWNlKFwiOnRpbWVcIiwgdGhpcy50aW1lKVxuICAgICAgLnJlcGxhY2UoXCI6cGVyY2VudFwiLCBwZXJjZW50KVxuICAgICAgLnJlcGxhY2UoXCI6Y29tcGxldGVkXCIsIGNvbXBsZXRlZCArIFwiXCIpXG4gICAgICAucmVwbGFjZShcIjp0b3RhbFwiLCB0b3RhbCArIFwiXCIpO1xuXG4gICAgLy8gY29tcHV0ZSB0aGUgYXZhaWxhYmxlIHNwYWNlIChub24temVybykgZm9yIHRoZSBiYXJcbiAgICBsZXQgYXZhaWxhYmxlU3BhY2UgPSBNYXRoLm1heChcbiAgICAgIDAsXG4gICAgICB0aGlzLnR0eUNvbHVtbnMgLSBzdHIucmVwbGFjZShcIjpiYXJcIiwgXCJcIikubGVuZ3RoLFxuICAgICk7XG4gICAgaWYgKGF2YWlsYWJsZVNwYWNlICYmIGlzV2luZG93KSBhdmFpbGFibGVTcGFjZSAtPSAxO1xuXG4gICAgY29uc3Qgd2lkdGggPSBNYXRoLm1pbih0aGlzLndpZHRoLCBhdmFpbGFibGVTcGFjZSk7XG4gICAgY29uc3QgZmluaXNoZWQgPSBjb21wbGV0ZWQgPj0gdG90YWw7XG5cbiAgICBjb25zdCBwcmVjaXNlQmFyID0gb3B0aW9ucy5wcmVjaXNlQmFyID8/IHRoaXMucHJlY2lzZUJhcjtcbiAgICBjb25zdCBwcmVjaXNpb24gPSBwcmVjaXNlQmFyLmxlbmd0aCA+IDE7XG5cbiAgICAvLyA6YmFyXG4gICAgY29uc3QgY29tcGxldGVMZW5ndGggPSB3aWR0aCAqIGNvbXBsZXRlZCAvIHRvdGFsO1xuICAgIGNvbnN0IHJvdW5kZWRDb21wbGV0ZUxlbmd0aCA9IE1hdGguZmxvb3IoY29tcGxldGVMZW5ndGgpO1xuXG4gICAgbGV0IHByZWNpc2UgPSBcIlwiO1xuICAgIGlmIChwcmVjaXNpb24pIHtcbiAgICAgIGNvbnN0IHByZWNpc2VMZW5ndGggPSBjb21wbGV0ZUxlbmd0aCAtIHJvdW5kZWRDb21wbGV0ZUxlbmd0aDtcbiAgICAgIHByZWNpc2UgPSBmaW5pc2hlZFxuICAgICAgICA/IFwiXCJcbiAgICAgICAgOiBwcmVjaXNlQmFyW01hdGguZmxvb3IocHJlY2lzZUJhci5sZW5ndGggKiBwcmVjaXNlTGVuZ3RoKV07XG4gICAgfVxuXG4gICAgY29uc3QgY29tcGxldGUgPSBuZXcgQXJyYXkocm91bmRlZENvbXBsZXRlTGVuZ3RoKS5maWxsKFxuICAgICAgb3B0aW9ucy5jb21wbGV0ZSA/PyB0aGlzLmNvbXBsZXRlLFxuICAgICkuam9pbihcIlwiKTtcbiAgICBjb25zdCBpbmNvbXBsZXRlID0gbmV3IEFycmF5KFxuICAgICAgTWF0aC5tYXgod2lkdGggLSByb3VuZGVkQ29tcGxldGVMZW5ndGggLSAocHJlY2lzaW9uID8gMSA6IDApLCAwKSxcbiAgICApLmZpbGwob3B0aW9ucy5pbmNvbXBsZXRlID8/IHRoaXMuaW5jb21wbGV0ZSkuam9pbihcIlwiKTtcblxuICAgIHN0ciA9IHN0ci5yZXBsYWNlKFwiOmJhclwiLCBjb21wbGV0ZSArIHByZWNpc2UgKyBpbmNvbXBsZXRlKTtcblxuICAgIGlmIChzdHIgIT09IHRoaXMubGFzdFN0cikge1xuICAgICAgdGhpcy53cml0ZShzdHIpO1xuICAgICAgdGhpcy5sYXN0U3RyID0gc3RyO1xuICAgIH1cblxuICAgIGlmIChmaW5pc2hlZCkgdGhpcy5lbmQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBlbmQ6IGVuZCBhIHByb2dyZXNzIGJhci5cbiAgICogTm8gbmVlZCB0byBjYWxsIGluIG1vc3QgY2FzZXMsIHVubGVzcyB5b3Ugd2FudCB0byBlbmQgYmVmb3JlIDEwMCVcbiAgICovXG4gIGVuZCgpOiB2b2lkIHtcbiAgICB0aGlzLmlzQ29tcGxldGVkID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5jbGVhcikge1xuICAgICAgdGhpcy5zdGRvdXRXcml0ZShcIlxcclwiKTtcbiAgICAgIHRoaXMuY2xlYXJMaW5lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYnJlYWtMaW5lKCk7XG4gICAgfVxuICAgIHRoaXMuc2hvd0N1cnNvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIGludGVycnVwdCB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCB3cml0ZSBhIG1lc3NhZ2UgYWJvdmUgaXRcbiAgICogXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHdyaXRlXG4gICAqL1xuICBjb25zb2xlKG1lc3NhZ2U6IHN0cmluZyB8IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuY2xlYXJMaW5lKCk7XG4gICAgdGhpcy53cml0ZShgJHttZXNzYWdlfWApO1xuICAgIHRoaXMuYnJlYWtMaW5lKCk7XG4gICAgdGhpcy53cml0ZSh0aGlzLmxhc3RTdHIpO1xuICB9XG5cbiAgcHJpdmF0ZSB3cml0ZShtc2c6IHN0cmluZyk6IHZvaWQge1xuICAgIG1zZyA9IGBcXHIke21zZ31cXHgxYls/MjVsYDtcbiAgICB0aGlzLnN0ZG91dFdyaXRlKG1zZyk7XG4gIH1cblxuICBwcml2YXRlIGdldCB0dHlDb2x1bW5zKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIDEwMDtcbiAgfVxuXG4gIHByaXZhdGUgYnJlYWtMaW5lKCkge1xuICAgIHRoaXMuc3Rkb3V0V3JpdGUoXCJcXHJcXG5cIik7XG4gIH1cblxuICBwcml2YXRlIHN0ZG91dFdyaXRlKG1zZzogc3RyaW5nKSB7XG4gICAgRGVuby53cml0ZUFsbFN5bmMoRGVuby5zdGRvdXQsIHRoaXMuZW5jb2Rlci5lbmNvZGUobXNnKSk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyTGluZShkaXJlY3Rpb246IERpcmVjdGlvbiA9IERpcmVjdGlvbi5hbGwpOiB2b2lkIHtcbiAgICBzd2l0Y2ggKGRpcmVjdGlvbikge1xuICAgICAgY2FzZSBEaXJlY3Rpb24uYWxsOlxuICAgICAgICB0aGlzLnN0ZG91dFdyaXRlKFwiXFx4MWJbMktcIik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBEaXJlY3Rpb24ubGVmdDpcbiAgICAgICAgdGhpcy5zdGRvdXRXcml0ZShcIlxceDFiWzFLXCIpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRGlyZWN0aW9uLnJpZ2h0OlxuICAgICAgICB0aGlzLnN0ZG91dFdyaXRlKFwiXFx4MWJbMEtcIik7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2hvd0N1cnNvcigpOiB2b2lkIHtcbiAgICB0aGlzLnN0ZG91dFdyaXRlKFwiXFx4MWJbPzI1aFwiKTtcbiAgfVxufVxuIl19