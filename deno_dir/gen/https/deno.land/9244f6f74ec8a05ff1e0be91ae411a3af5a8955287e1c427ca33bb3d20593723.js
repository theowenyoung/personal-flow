import { get } from "./utils/get.ts";
import { getFrom } from "./get-from.ts";
import { runScript } from "./utils/run-script.ts";
import { isClass } from "./utils/object.ts";
import { hasPermissionSlient } from "./permission.ts";
export function getStepResponse(ctx) {
    return {
        result: ctx.public.result,
        ok: ctx.public.ok,
        isRealOk: ctx.public.isRealOk,
        error: ctx.public.error,
        cmdResult: ctx.public.cmdResult,
        cmdCode: ctx.public.cmdCode,
        cmdOk: ctx.public.cmdOk,
        cmdError: ctx.public.cmdError,
    };
}
export function setOkResult(ctx, stepResult) {
    ctx.public.result = stepResult;
    ctx.public.ok = true;
    ctx.public.isRealOk = true;
    ctx.public.error = undefined;
    return ctx;
}
export function setErrorResult(ctx, error) {
    ctx.public.result = undefined;
    ctx.public.error = error;
    ctx.public.isRealOk = false;
    ctx.public.ok = false;
    if (error.code !== undefined) {
        ctx.public.cmdCode = error.code;
        ctx.public.cmdError = error.message;
        ctx.public.cmdOk = false;
        ctx.public.cmdResult = undefined;
    }
    return ctx;
}
class Sample {
    constructor(args) {
    }
}
export async function runStep(ctx, step) {
    const { reporter } = step;
    if (step.env) {
        for (const key in step.env) {
            const value = step.env[key];
            if (typeof value === "string") {
                const debugEnvPermmision = { name: "env", variable: key };
                if (await hasPermissionSlient(debugEnvPermmision)) {
                    Deno.env.set(key, value);
                }
            }
        }
    }
    let stepResult;
    try {
        const from = step.from;
        let use;
        const args = step.args || [];
        if (from) {
            const lib = await getFrom(ctx, from, reporter);
            use = get(lib, step.use ?? "default");
            if (step.use && !use) {
                use = get(lib.default, step.use);
            }
            if (step.use && !use) {
                throw new Error(`Can not get use module: ${step.use}`);
            }
        }
        else if (step.use &&
            typeof globalThis[step.use] === "function") {
            use = globalThis[step.use];
        }
        else if (step.use && step.use.startsWith("Deno.")) {
            const denoApiMethod = step.use.replace("Deno.", "");
            use = get(Deno, denoApiMethod);
        }
        else if (step.use) {
            throw new Error(`${step.use} is not a function`);
        }
        if (use && isClass(use)) {
            reporter.debug(`Run ${use.name} instance with args: ${JSON.stringify(args, null, 2)}`);
            stepResult = await new use(...args);
            ctx = setOkResult(ctx, stepResult);
            reporter.debug(`use: result: ${typeof stepResult === "string"
                ? stepResult
                : JSON.stringify(stepResult, null, 2)}`);
        }
        else if (typeof use === "function") {
            reporter.debug(`Run function ${use.name} with args: ${JSON.stringify(args, null, 2)}`);
            stepResult = await use(...args);
            ctx = setOkResult(ctx, stepResult);
            reporter.debug(`use: result: ${typeof stepResult === "string"
                ? stepResult
                : JSON.stringify(stepResult, null, 2)}`);
        }
        else if (use !== undefined) {
            const e = "`use` must be a function, but got " + typeof use;
            throw new Error(e);
        }
    }
    catch (e) {
        reporter.warning(`Failed to run use`);
        throw e;
    }
    if (step.run) {
        try {
            const scriptResult = await runScript(step.run, {
                ctx: ctx.public,
            });
            stepResult = scriptResult.result;
            ctx = setOkResult(ctx, stepResult);
            ctx.public.state = scriptResult.ctx.state;
            reporter.debug(`Result: ${typeof stepResult === "string"
                ? stepResult
                : JSON.stringify(stepResult, null, 2)}`, "Success run script");
        }
        catch (e) {
            reporter.warning(`Failed to run script`);
            throw e;
        }
    }
    ctx.public.ok = true;
    return ctx;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuLXN0ZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJydW4tc3RlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBS3RELE1BQU0sVUFBVSxlQUFlLENBQUMsR0FBWTtJQUMxQyxPQUFPO1FBQ0wsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTTtRQUN6QixFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFHO1FBQ2xCLFFBQVEsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVM7UUFDOUIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztRQUN2QixTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTO1FBQy9CLE9BQU8sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU87UUFDM0IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztRQUN2QixRQUFRLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRO0tBQzlCLENBQUM7QUFDSixDQUFDO0FBQ0QsTUFBTSxVQUFVLFdBQVcsQ0FBQyxHQUFZLEVBQUUsVUFBbUI7SUFDM0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO0lBQy9CLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQztJQUNyQixHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDM0IsR0FBRyxDQUFDLE1B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QztTQUNIO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixRQUFRLENBQUMsT0FBTyxDQUNkLHNCQUFzQixDQUN2QixDQUFDO1lBRUYsTUFBTSxDQUFDLENBQUM7U0FDVDtLQUNGO0lBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0ZXBPcHRpb25zLCBTdGVwUmVzcG9uc2UgfSBmcm9tIFwiLi9pbnRlcmZhY2UudHNcIjtcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi9pbnRlcm5hbC1pbnRlcmZhY2UudHNcIjtcbmltcG9ydCB7IGxvZyB9IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBnZXQgfSBmcm9tIFwiLi91dGlscy9nZXQudHNcIjtcbmltcG9ydCB7IGdldEZyb20gfSBmcm9tIFwiLi9nZXQtZnJvbS50c1wiO1xuaW1wb3J0IHsgcnVuU2NyaXB0IH0gZnJvbSBcIi4vdXRpbHMvcnVuLXNjcmlwdC50c1wiO1xuaW1wb3J0IHsgaXNDbGFzcyB9IGZyb20gXCIuL3V0aWxzL29iamVjdC50c1wiO1xuaW1wb3J0IHsgaGFzUGVybWlzc2lvblNsaWVudCB9IGZyb20gXCIuL3Blcm1pc3Npb24udHNcIjtcblxuaW50ZXJmYWNlIFJ1blN0ZXBPcHRpb24gZXh0ZW5kcyBTdGVwT3B0aW9ucyB7XG4gIHJlcG9ydGVyOiBsb2cuTG9nZ2VyO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFN0ZXBSZXNwb25zZShjdHg6IENvbnRleHQpOiBTdGVwUmVzcG9uc2Uge1xuICByZXR1cm4ge1xuICAgIHJlc3VsdDogY3R4LnB1YmxpYy5yZXN1bHQsXG4gICAgb2s6IGN0eC5wdWJsaWMub2shLFxuICAgIGlzUmVhbE9rOiBjdHgucHVibGljLmlzUmVhbE9rISxcbiAgICBlcnJvcjogY3R4LnB1YmxpYy5lcnJvcixcbiAgICBjbWRSZXN1bHQ6IGN0eC5wdWJsaWMuY21kUmVzdWx0LFxuICAgIGNtZENvZGU6IGN0eC5wdWJsaWMuY21kQ29kZSxcbiAgICBjbWRPazogY3R4LnB1YmxpYy5jbWRPayxcbiAgICBjbWRFcnJvcjogY3R4LnB1YmxpYy5jbWRFcnJvcixcbiAgfTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBzZXRPa1Jlc3VsdChjdHg6IENvbnRleHQsIHN0ZXBSZXN1bHQ6IHVua25vd24pOiBDb250ZXh0IHtcbiAgY3R4LnB1YmxpYy5yZXN1bHQgPSBzdGVwUmVzdWx0O1xuICBjdHgucHVibGljLm9rID0gdHJ1ZTtcbiAgY3R4LnB1YmxpYy5pc1JlYWxPayA9IHRydWU7XG4gIGN0eC5wdWJsaWMuZXJyb3IgPSB1bmRlZmluZWQ7XG4gIHJldHVybiBjdHg7XG59XG5leHBvcnQgZnVuY3Rpb24gc2V0RXJyb3JSZXN1bHQoY3R4OiBDb250ZXh0LCBlcnJvcjogdW5rbm93bik6IENvbnRleHQge1xuICBjdHgucHVibGljLnJlc3VsdCA9IHVuZGVmaW5lZDtcbiAgY3R4LnB1YmxpYy5lcnJvciA9IGVycm9yO1xuICBjdHgucHVibGljLmlzUmVhbE9rID0gZmFsc2U7XG4gIGN0eC5wdWJsaWMub2sgPSBmYWxzZTtcbiAgaWYgKChlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikuY29kZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgY3R4LnB1YmxpYy5jbWRDb2RlID0gKGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5jb2RlIGFzIG51bWJlcjtcbiAgICBjdHgucHVibGljLmNtZEVycm9yID0gKGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5tZXNzYWdlIGFzIHN0cmluZztcbiAgICBjdHgucHVibGljLmNtZE9rID0gZmFsc2U7XG4gICAgY3R4LnB1YmxpYy5jbWRSZXN1bHQgPSB1bmRlZmluZWQ7XG4gIH1cbiAgcmV0dXJuIGN0eDtcbn1cblxuY2xhc3MgU2FtcGxlIHtcbiAgY29uc3RydWN0b3IoYXJnczogc3RyaW5nKSB7XG4gICAgLy8gZG8gdGhpXG4gIH1cbn1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5TdGVwKFxuICBjdHg6IENvbnRleHQsXG4gIHN0ZXA6IFJ1blN0ZXBPcHRpb24sXG4pOiBQcm9taXNlPENvbnRleHQ+IHtcbiAgLy8gY29uc3QgY3VycmVudFN0ZXBUeXBlID0gY3R4LmN1cnJlbnRTdGVwVHlwZTtcbiAgY29uc3QgeyByZXBvcnRlciB9ID0gc3RlcDtcbiAgLy8gY2xlYXIgdGVtcCBzdGF0ZVxuICAvLyBpZiAoY3VycmVudFN0ZXBUeXBlID09PSBTdGVwVHlwZS5Tb3VyY2UpIHtcbiAgLy8gICByZXBvcnRlci5kZWJ1ZyhcbiAgLy8gICAgIGBTb3VyY2UgT3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShzdGVwLCBudWxsLCAyKX1gLFxuICAvLyAgICk7XG4gIC8vIH0gZWxzZSBpZiAoY3VycmVudFN0ZXBUeXBlID09PSBTdGVwVHlwZS5GaWx0ZXIpIHtcbiAgLy8gICByZXBvcnRlci5kZWJ1ZyhcbiAgLy8gICAgIGBGaWx0ZXIgT3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShzdGVwLCBudWxsLCAyKX1gLFxuICAvLyAgICk7XG4gIC8vIH0gZWxzZSBpZiAoY3VycmVudFN0ZXBUeXBlID09PSBTdGVwVHlwZS5TdGVwKSB7XG4gIC8vICAgcmVwb3J0ZXIuZGVidWcoXG4gIC8vICAgICBgU3RlcCByZWNlaXZlIGl0ZW06ICR7SlNPTi5zdHJpbmdpZnkoY3R4LnB1YmxpYy5pdGVtLCBudWxsLCAyKX1gLFxuICAvLyAgICk7XG4gIC8vICAgcmVwb3J0ZXIuZGVidWcoXG4gIC8vICAgICBgU3RlcCBPcHRpb25zOiAke0pTT04uc3RyaW5naWZ5KHN0ZXAsIG51bGwsIDIpfWAsXG4gIC8vICAgKTtcbiAgLy8gfVxuXG4gIC8vIHBhcnNlIGVudiB0byBlbnZcbiAgaWYgKHN0ZXAuZW52KSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gc3RlcC5lbnYpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gc3RlcC5lbnZba2V5XTtcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgY29uc3QgZGVidWdFbnZQZXJtbWlzaW9uID0geyBuYW1lOiBcImVudlwiLCB2YXJpYWJsZToga2V5IH0gYXMgY29uc3Q7XG4gICAgICAgIGlmIChhd2FpdCBoYXNQZXJtaXNzaW9uU2xpZW50KGRlYnVnRW52UGVybW1pc2lvbikpIHtcbiAgICAgICAgICBEZW5vLmVudi5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgbGV0IHN0ZXBSZXN1bHQ7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBmcm9tID0gc3RlcC5mcm9tO1xuICAgIGxldCB1c2U7XG4gICAgY29uc3QgYXJncyA9IHN0ZXAuYXJncyB8fCBbXTtcblxuICAgIGlmIChmcm9tKSB7XG4gICAgICBjb25zdCBsaWIgPSBhd2FpdCBnZXRGcm9tKGN0eCwgZnJvbSwgcmVwb3J0ZXIpO1xuXG4gICAgICB1c2UgPSBnZXQobGliLCBzdGVwLnVzZSA/PyBcImRlZmF1bHRcIik7XG4gICAgICBpZiAoc3RlcC51c2UgJiYgIXVzZSkge1xuICAgICAgICAvLyB0cnkgdG8gZ2V0IHVzZSBmcm9tIGRlZmF1bHRcbiAgICAgICAgdXNlID0gZ2V0KGxpYi5kZWZhdWx0LCBzdGVwLnVzZSEpO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3RlcC51c2UgJiYgIXVzZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbiBub3QgZ2V0IHVzZSBtb2R1bGU6ICR7c3RlcC51c2V9YCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHN0ZXAudXNlICYmXG4gICAgICB0eXBlb2YgKGdsb2JhbFRoaXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pW3N0ZXAudXNlXSA9PT0gXCJmdW5jdGlvblwiXG4gICAgKSB7XG4gICAgICAvLyBUT0RPIGNoZWNrIGRlZmF1bHQgYXBwXG4gICAgICB1c2UgPSAoZ2xvYmFsVGhpcyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilbc3RlcC51c2VdO1xuICAgIH0gZWxzZSBpZiAoc3RlcC51c2UgJiYgc3RlcC51c2Uuc3RhcnRzV2l0aChcIkRlbm8uXCIpKSB7XG4gICAgICBjb25zdCBkZW5vQXBpTWV0aG9kID0gc3RlcC51c2UucmVwbGFjZShcIkRlbm8uXCIsIFwiXCIpO1xuICAgICAgdXNlID0gZ2V0KERlbm8sIGRlbm9BcGlNZXRob2QpO1xuICAgIH0gZWxzZSBpZiAoc3RlcC51c2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtzdGVwLnVzZX0gaXMgbm90IGEgZnVuY3Rpb25gKTtcbiAgICB9XG5cbiAgICBpZiAodXNlICYmIGlzQ2xhc3ModXNlKSkge1xuICAgICAgcmVwb3J0ZXIuZGVidWcoXG4gICAgICAgIGBSdW4gJHsodXNlIGFzICgpID0+IGJvb2xlYW4pLm5hbWV9IGluc3RhbmNlIHdpdGggYXJnczogJHtcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeShhcmdzLCBudWxsLCAyKVxuICAgICAgICB9YCxcbiAgICAgICk7XG5cbiAgICAgIC8vIEB0cy1pZ25vcmU6IFVucmVhY2hhYmxlIGNvZGUgZXJyb3JcbiAgICAgIHN0ZXBSZXN1bHQgPSBhd2FpdCBuZXcgdXNlKFxuICAgICAgICAuLi5hcmdzLFxuICAgICAgKTtcbiAgICAgIGN0eCA9IHNldE9rUmVzdWx0KGN0eCwgc3RlcFJlc3VsdCk7XG5cbiAgICAgIHJlcG9ydGVyLmRlYnVnKFxuICAgICAgICBgdXNlOiByZXN1bHQ6ICR7XG4gICAgICAgICAgdHlwZW9mIHN0ZXBSZXN1bHQgPT09IFwic3RyaW5nXCJcbiAgICAgICAgICAgID8gc3RlcFJlc3VsdFxuICAgICAgICAgICAgOiBKU09OLnN0cmluZ2lmeShzdGVwUmVzdWx0LCBudWxsLCAyKVxuICAgICAgICB9YCxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdXNlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHJlcG9ydGVyLmRlYnVnKFxuICAgICAgICBgUnVuIGZ1bmN0aW9uICR7dXNlLm5hbWV9IHdpdGggYXJnczogJHtKU09OLnN0cmluZ2lmeShhcmdzLCBudWxsLCAyKX1gLFxuICAgICAgKTtcblxuICAgICAgc3RlcFJlc3VsdCA9IGF3YWl0IHVzZSguLi5hcmdzKTtcblxuICAgICAgY3R4ID0gc2V0T2tSZXN1bHQoY3R4LCBzdGVwUmVzdWx0KTtcblxuICAgICAgcmVwb3J0ZXIuZGVidWcoXG4gICAgICAgIGB1c2U6IHJlc3VsdDogJHtcbiAgICAgICAgICB0eXBlb2Ygc3RlcFJlc3VsdCA9PT0gXCJzdHJpbmdcIlxuICAgICAgICAgICAgPyBzdGVwUmVzdWx0XG4gICAgICAgICAgICA6IEpTT04uc3RyaW5naWZ5KHN0ZXBSZXN1bHQsIG51bGwsIDIpXG4gICAgICAgIH1gLFxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHVzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBlID0gXCJgdXNlYCBtdXN0IGJlIGEgZnVuY3Rpb24sIGJ1dCBnb3QgXCIgKyB0eXBlb2YgdXNlO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIHJlcG9ydGVyLndhcm5pbmcoXG4gICAgICBgRmFpbGVkIHRvIHJ1biB1c2VgLFxuICAgICk7XG4gICAgdGhyb3cgZTtcbiAgfVxuXG4gIC8vIGNoZWNrIGlmIHRoZW5cbiAgaWYgKHN0ZXAucnVuKSB7XG4gICAgLy8gcnVuIHRoZW5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2NyaXB0UmVzdWx0ID0gYXdhaXQgcnVuU2NyaXB0KHN0ZXAucnVuLCB7XG4gICAgICAgIGN0eDogY3R4LnB1YmxpYyxcbiAgICAgIH0pO1xuXG4gICAgICBzdGVwUmVzdWx0ID0gc2NyaXB0UmVzdWx0LnJlc3VsdDtcbiAgICAgIGN0eCA9IHNldE9rUmVzdWx0KGN0eCwgc3RlcFJlc3VsdCk7XG4gICAgICBjdHgucHVibGljLnN0YXRlID0gc2NyaXB0UmVzdWx0LmN0eC5zdGF0ZTtcbiAgICAgIHJlcG9ydGVyLmRlYnVnKFxuICAgICAgICBgUmVzdWx0OiAke1xuICAgICAgICAgIHR5cGVvZiBzdGVwUmVzdWx0ID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgICA/IHN0ZXBSZXN1bHRcbiAgICAgICAgICAgIDogSlNPTi5zdHJpbmdpZnkoc3RlcFJlc3VsdCwgbnVsbCwgMilcbiAgICAgICAgfWAsXG4gICAgICAgIFwiU3VjY2VzcyBydW4gc2NyaXB0XCIsXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlcG9ydGVyLndhcm5pbmcoXG4gICAgICAgIGBGYWlsZWQgdG8gcnVuIHNjcmlwdGAsXG4gICAgICApO1xuXG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGN0eC5wdWJsaWMub2sgPSB0cnVlO1xuICByZXR1cm4gY3R4O1xufVxuIl19