import instantiate from "../build/sqlite.js";
import { getStr, setArr, setStr } from "./wasm.ts";
import { Status, Values } from "./constants.ts";
import SqliteError from "./error.ts";
import { Empty, Rows } from "./rows.ts";
export class DB {
    _wasm;
    _open;
    _transactions;
    constructor(path = ":memory:") {
        this._wasm = instantiate().exports;
        this._open = false;
        this._transactions = new Set();
        let status;
        setStr(this._wasm, path, (ptr) => {
            status = this._wasm.open(ptr);
        });
        if (status !== Status.SqliteOk) {
            throw this._error();
        }
        this._open = true;
    }
    query(sql, values) {
        if (!this._open) {
            throw new SqliteError("Database was closed.");
        }
        let stmt = Values.Null;
        setStr(this._wasm, sql, (ptr) => {
            stmt = this._wasm.prepare(ptr);
        });
        if (stmt === Values.Null) {
            throw this._error();
        }
        let parameters = [];
        if (Array.isArray(values)) {
            parameters = values;
        }
        else if (typeof values === "object") {
            for (const key of Object.keys(values)) {
                let idx = Values.Error;
                let name = key;
                if (name[0] !== ":" && name[0] !== "@" && name[0] !== "$") {
                    name = `:${name}`;
                }
                setStr(this._wasm, name, (ptr) => {
                    idx = this._wasm.bind_parameter_index(stmt, ptr);
                });
                if (idx === Values.Error) {
                    this._wasm.finalize(stmt);
                    throw new SqliteError(`No parameter named '${name}'.`);
                }
                parameters[idx - 1] = values[key];
            }
        }
        for (let i = 0; i < parameters.length; i++) {
            let value = parameters[i];
            let status;
            switch (typeof value) {
                case "boolean":
                    value = value ? 1 : 0;
                case "number":
                    if (Number.isSafeInteger(value)) {
                        status = this._wasm.bind_int(stmt, i + 1, value);
                    }
                    else {
                        status = this._wasm.bind_double(stmt, i + 1, value);
                    }
                    break;
                case "bigint":
                    setStr(this._wasm, value.toString(), (ptr) => {
                        status = this._wasm.bind_big_int(stmt, i + 1, ptr);
                    });
                    break;
                case "string":
                    setStr(this._wasm, value, (ptr) => {
                        status = this._wasm.bind_text(stmt, i + 1, ptr);
                    });
                    break;
                default:
                    if (value instanceof Date) {
                        setStr(this._wasm, value.toISOString(), (ptr) => {
                            status = this._wasm.bind_text(stmt, i + 1, ptr);
                        });
                    }
                    else if (value instanceof Uint8Array) {
                        setArr(this._wasm, value, (ptr) => {
                            status = this._wasm.bind_blob(stmt, i + 1, ptr, value.length);
                        });
                    }
                    else if (value === null || value === undefined) {
                        status = this._wasm.bind_null(stmt, i + 1);
                    }
                    else {
                        this._wasm.finalize(stmt);
                        throw new SqliteError(`Can not bind ${typeof value}.`);
                    }
                    break;
            }
            if (status !== Status.SqliteOk) {
                this._wasm.finalize(stmt);
                throw this._error(status);
            }
        }
        const status = this._wasm.step(stmt);
        switch (status) {
            case Status.SqliteDone:
                this._wasm.finalize(stmt);
                return Empty;
                break;
            case Status.SqliteRow:
                const transaction = new Rows(this, stmt);
                this._transactions.add(transaction);
                return transaction;
                break;
            default:
                this._wasm.finalize(stmt);
                throw this._error(status);
                break;
        }
    }
    close(force = false) {
        if (!this._open) {
            return;
        }
        if (force) {
            for (const transaction of this._transactions) {
                transaction.return();
            }
        }
        if (this._wasm.close() !== Status.SqliteOk) {
            throw this._error();
        }
        this._open = false;
    }
    get lastInsertRowId() {
        return this._wasm.last_insert_rowid();
    }
    get changes() {
        return this._wasm.changes();
    }
    get totalChanges() {
        return this._wasm.total_changes();
    }
    _error(code) {
        if (code === undefined) {
            code = this._wasm.get_status();
        }
        const msg = getStr(this._wasm, this._wasm.get_sqlite_error_str());
        return new SqliteError(msg, code);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFdBQVcsTUFBTSxvQkFBb0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLFdBQVcsTUFBTSxZQUFZLENBQUM7QUFDckMsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFheEMsTUFBTSxPQUFPLEVBQUU7SUFDTCxLQUFLLENBQU07SUFDWCxLQUFLLENBQVU7SUFDZixhQUFhLENBQVk7SUFZakMsWUFBWSxPQUFlLFVBQVU7UUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRy9CLElBQUksTUFBTSxDQUFDO1FBQ1gsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDL0IsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxNQUFNLEtBQUssTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUM5QixNQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ3BCLENBQUM7SUFrRUQsS0FBSyxDQUFDLEdBQVcsRUFBRSxNQUE4QjtRQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZ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LEtBQUssRUFBRTtZQUNULEtBQUssTUFBTSxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDNUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ3RCO1NBQ0Y7UUFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUMxQyxNQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFXRCxJQUFJLGVBQWU7UUFDakIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDeEMsQ0FBQztJQVVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBVUQsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFTyxNQUFNLENBQUMsSUFBYTtRQUMxQixJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7WUFDdEIsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFZLENBQUM7U0FDMUM7UUFDRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQztRQUNsRSxPQUFPLElBQUksV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaW5zdGFudGlhdGUgZnJvbSBcIi4uL2J1aWxkL3NxbGl0ZS5qc1wiO1xuaW1wb3J0IHsgZ2V0U3RyLCBzZXRBcnIsIHNldFN0ciB9IGZyb20gXCIuL3dhc20udHNcIjtcbmltcG9ydCB7IFN0YXR1cywgVmFsdWVzIH0gZnJvbSBcIi4vY29uc3RhbnRzLnRzXCI7XG5pbXBvcnQgU3FsaXRlRXJyb3IgZnJvbSBcIi4vZXJyb3IudHNcIjtcbmltcG9ydCB7IEVtcHR5LCBSb3dzIH0gZnJvbSBcIi4vcm93cy50c1wiO1xuXG4vLyBQb3NzaWJsZSBwYXJhbWV0ZXJzIHRvIGJlIGJvdW5kIHRvIGEgcXVlcnlcbnR5cGUgUXVlcnlQYXJhbSA9XG4gIHwgYm9vbGVhblxuICB8IG51bWJlclxuICB8IGJpZ2ludFxuICB8IHN0cmluZ1xuICB8IG51bGxcbiAgfCB1bmRlZmluZWRcbiAgfCBEYXRlXG4gIHwgVWludDhBcnJheTtcblxuZXhwb3J0IGNsYXNzIERCIHtcbiAgcHJpdmF0ZSBfd2FzbTogYW55O1xuICBwcml2YXRlIF9vcGVuOiBib29sZWFuO1xuICBwcml2YXRlIF90cmFuc2FjdGlvbnM6IFNldDxSb3dzPjtcblxuICAvKipcbiAgICogREJcbiAgICpcbiAgICogQ3JlYXRlIGEgbmV3IGRhdGFiYXNlLiBUaGUgcGFzc2VkXG4gICAqIHBhdGggd2lsbCBiZSBvcGVuZWQgd2l0aCByZWFkLyB3cml0ZVxuICAgKiBwZXJtaXNzaW9ucyBhbmQgY3JlYXRlZCBpZiBpdCBkb2VzIG5vdFxuICAgKiBhbHJlYWR5IGV4aXN0LlxuICAgKlxuICAgKiBUaGUgZGVmYXVsdCBvcGVucyBhbiBpbi1tZW1vcnkgZGF0YWJhc2UuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihwYXRoOiBzdHJpbmcgPSBcIjptZW1vcnk6XCIpIHtcbiAgICB0aGlzLl93YXNtID0gaW5zdGFudGlhdGUoKS5leHBvcnRzO1xuICAgIHRoaXMuX29wZW4gPSBmYWxzZTtcbiAgICB0aGlzLl90cmFuc2FjdGlvbnMgPSBuZXcgU2V0KCk7XG5cbiAgICAvLyBUcnkgdG8gb3BlbiB0aGUgZGF0YWJhc2VcbiAgICBsZXQgc3RhdHVzO1xuICAgIHNldFN0cih0aGlzLl93YXNtLCBwYXRoLCAocHRyKSA9PiB7XG4gICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLm9wZW4ocHRyKTtcbiAgICB9KTtcbiAgICBpZiAoc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlT2spIHtcbiAgICAgIHRocm93IHRoaXMuX2Vycm9yKCk7XG4gICAgfVxuICAgIHRoaXMuX29wZW4gPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIERCLnF1ZXJ5XG4gICAqXG4gICAqIFJ1biBhIHF1ZXJ5IGFnYWluc3QgdGhlIGRhdGFiYXNlLiBUaGUgcXVlcnlcbiAgICogY2FuIGNvbnRhaW4gcGxhY2Vob2xkZXIgcGFyYW1ldGVycywgd2hpY2hcbiAgICogYXJlIGJvdW5kIHRvIHRoZSB2YWx1ZXMgcGFzc2VkIGluICd2YWx1ZXMnLlxuICAgKlxuICAgKiAgICAgZGIucXVlcnkoXCJTRUxFQ1QgbmFtZSwgZW1haWwgRlJPTSB1c2VycyBXSEVSRSBzdWJzY3JpYmVkID0gPyBBTkQgbGlzdCBMSUtFID9cIiwgW3RydWUsIGxpc3ROYW1lXSk7XG4gICAqXG4gICAqIFRoaXMgc3VwcG9ydHMgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGFyYW1ldGVycy5cbiAgICogUG9zaXRpb25hbCBwYXJhbWV0ZXJzIGNhbiBiZSBzZXQgYnkgcGFzc2luZyBhblxuICAgKiBhcnJheSBmb3IgdmFsdWVzLiBOYW1lZCBwYXJhbWV0ZXJzIGNhbiBiZSBzZXRcbiAgICogYnkgcGFzc2luZyBhbiBvYmplY3QgZm9yIHZhbHVlcy5cbiAgICpcbiAgICogV2hpbGUgdGhleSBjYW4gYmUgbWl4ZWQgaW4gcHJpbmNpcGxlLCB0aGlzIGlzXG4gICAqIG5vdCByZWNvbW1lbmRlZC5cbiAgICpcbiAgICogfCBQYXJhbWV0ZXIgICAgIHwgVmFsdWVzICAgICAgICAgICAgICAgICAgfFxuICAgKiB8LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18XG4gICAqIHwgYD9OTk5gIG9yIGA/YCB8IE5OTi10aCB2YWx1ZSBpbiBhcnJheSAgIHxcbiAgICogfCBgOkFBQUFgICAgICAgIHwgdmFsdWUgYEFBQUFgIG9yIGA6QUFBQWAgfFxuICAgKiB8IGBAQUFBQWAgICAgICAgfCB2YWx1ZSBgQEFBQUFgICAgICAgICAgICB8XG4gICAqIHwgYCRBQUFBYCAgICAgICB8IHZhbHVlIGAkQUFBQWAgICAgICAgICAgIHxcbiAgICpcbiAgICogKHNlZSBodHRwczovL3d3dy5zcWxpdGUub3JnL2xhbmdfZXhwci5odG1sKVxuICAgKlxuICAgKiBWYWx1ZXMgbWF5IG9ubHkgYmUgb2YgdGhlIGZvbGxvd2luZ1xuICAgKiB0eXBlcyBhbmQgYXJlIGNvbnZlcnRlZCBhcyBmb2xsb3dzOlxuICAgKlxuICAgKiB8IEpTIGluICAgICAgfCBTUUwgdHlwZSAgICAgICAgfCBKUyBvdXQgICAgICAgICAgIHxcbiAgICogfC0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS18XG4gICAqIHwgbnVtYmVyICAgICB8IElOVEVHRVIgb3IgUkVBTCB8IG51bWJlciBvciBiaWdpbnQgfFxuICAgKiB8IGJpZ2ludCAgICAgfCBJTlRFR0VSICAgICAgICAgfCBudW1iZXIgb3IgYmlnaW50IHxcbiAgICogfCBib29sZWFuICAgIHwgSU5URUdFUiAgICAgICAgIHwgbnVtYmVyICAgICAgICAgICB8XG4gICAqIHwgc3RyaW5nICAgICB8IFRFWFQgICAgICAgICAgICB8IHN0cmluZyAgICAgICAgICAgfFxuICAgKiB8IERhdGUgICAgICAgfCBURVhUICAgICAgICAgICAgfCBzdHJpbmcgICAgICAgICAgIHxcbiAgICogfCBVaW50OEFycmF5IHwgQkxPQiAgICAgICAgICAgIHwgVWludDhBcnJheSAgICAgICB8XG4gICAqIHwgbnVsbCAgICAgICB8IE5VTEwgICAgICAgICAgICB8IG51bGwgICAgICAgICAgICAgfFxuICAgKiB8IHVuZGVmaW5lZCAgfCBOVUxMICAgICAgICAgICAgfCBudWxsICAgICAgICAgICAgIHxcbiAgICpcbiAgICogSWYgbm8gdmFsdWUgaXMgcHJvdmlkZWQgdG8gYSBnaXZlbiBwYXJhbWV0ZXIsXG4gICAqIFNRTGl0ZSB3aWxsIGRlZmF1bHQgdG8gTlVMTC5cbiAgICpcbiAgICogSWYgYSBgYmlnaW50YCBpcyBib3VuZCwgaXQgaXMgY29udmVydGVkIHRvIGFcbiAgICogc2lnbmVkIDY0IGJpZyBpbnRlZ2VyLCB3aGljaCBtYXkgbm90IGJlIGxvc3NsZXNzLlxuICAgKiBJZiBhbiBpbnRlZ2VyIHZhbHVlIGlzIHJlYWQgZnJvbSB0aGUgZGF0YWJhc2UsIHdoaWNoXG4gICAqIGlzIHRvbyBiaWcgdG8gc2FmZWx5IGJlIGNvbnRhaW5lZCBpbiBhIGBudW1iZXJgLCBpdFxuICAgKiBpcyBhdXRvbWF0aWNhbGx5IHJldHVybmVkIGFzIGEgYGJpZ2ludGAuXG4gICAqXG4gICAqIElmIGEgYERhdGVgIGlzIGJvdW5kLCBpdCB3aWxsIGJlIGNvbnZlcnRlZCB0b1xuICAgKiBhbiBJU08gODYwMSBzdHJpbmc6IGBZWVlZLU1NLUREVEhIOk1NOlNTLlNTU1pgLlxuICAgKiBUaGlzIGZvcm1hdCBpcyB1bmRlcnN0b29kIGJ5IGJ1aWx0LWluIFNRTGl0ZVxuICAgKiBkYXRlLXRpbWUgZnVuY3Rpb25zLiBBbHNvIHNlZVxuICAgKiBodHRwczovL3NxbGl0ZS5vcmcvbGFuZ19kYXRlZnVuYy5odG1sLlxuICAgKlxuICAgKiBUaGlzIGFsd2F5cyByZXR1cm5zIGFuIGl0ZXJhYmxlIFJvd3Mgb2JqZWN0LlxuICAgKiBBcyBhIHNwZWNpYWwgY2FzZSwgaWYgdGhlIHF1ZXJ5IGhhcyBubyByb3dzXG4gICAqIHRvIHJldHVybiB0aGlzIHJldHVybnMgdGhlIEVtcHR5IHJvdyAod2hpY2hcbiAgICogaXMgYWxzbyBpdGVyYWJsZSwgYnV0IGhhcyB6ZXJvIGVudHJpZXMpLlxuICAgKlxuICAgKiAhPiBBbnkgcmV0dXJuZWQgUm93cyBvYmplY3QgbmVlZHMgdG8gYmUgZnVsbHlcbiAgICogaXRlcmF0ZWQgb3ZlciBvciBkaXNjYXJkZWQgYnkgY2FsbGluZ1xuICAgKiBgLnJldHVybigpYCBvciBjbG9zaW5nIHRoZSBpdGVyYXRvci5cbiAgICovXG4gIHF1ZXJ5KHNxbDogc3RyaW5nLCB2YWx1ZXM/OiBvYmplY3QgfCBRdWVyeVBhcmFtW10pOiBSb3dzIHtcbiAgICBpZiAoIXRoaXMuX29wZW4pIHtcbiAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcihcIkRhdGFiYXNlIHdhcyBjbG9zZWQuXCIpO1xuICAgIH1cblxuICAgIC8vIFByZXBhcmUgc3FsaXRlIHF1ZXJ5IHN0YXRlbWVudFxuICAgIGxldCBzdG10OiBudW1iZXIgPSBWYWx1ZXMuTnVsbDtcbiAgICBzZXRTdHIodGhpcy5fd2FzbSwgc3FsLCAocHRyKSA9PiB7XG4gICAgICBzdG10ID0gdGhpcy5fd2FzbS5wcmVwYXJlKHB0cik7XG4gICAgfSk7XG4gICAgaWYgKHN0bXQgPT09IFZhbHVlcy5OdWxsKSB7XG4gICAgICB0aHJvdyB0aGlzLl9lcnJvcigpO1xuICAgIH1cblxuICAgIC8vIFByZXBhcmUgcGFyYW1ldGVyIGFycmF5XG4gICAgbGV0IHBhcmFtZXRlcnM6IGFueVtdID0gW107XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzKSkge1xuICAgICAgcGFyYW1ldGVycyA9IHZhbHVlcztcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZXMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIC8vIFJlc29sdmUgcGFyYW1ldGVyIGluZGV4IGZvciBuYW1lZCB2YWx1ZXNcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHZhbHVlcykpIHtcbiAgICAgICAgbGV0IGlkeCA9IFZhbHVlcy5FcnJvcjtcbiAgICAgICAgLy8gUHJlcGVuZCAnOicgdG8gbmFtZSwgaWYgaXQgZG9lcyBub3QgaGF2ZSBhIHNwZWNpYWwgc3RhcnRpbmcgY2hhcmFjdGVyXG4gICAgICAgIGxldCBuYW1lID0ga2V5O1xuICAgICAgICBpZiAobmFtZVswXSAhPT0gXCI6XCIgJiYgbmFtZVswXSAhPT0gXCJAXCIgJiYgbmFtZVswXSAhPT0gXCIkXCIpIHtcbiAgICAgICAgICBuYW1lID0gYDoke25hbWV9YDtcbiAgICAgICAgfVxuICAgICAgICBzZXRTdHIodGhpcy5fd2FzbSwgbmFtZSwgKHB0cikgPT4ge1xuICAgICAgICAgIGlkeCA9IHRoaXMuX3dhc20uYmluZF9wYXJhbWV0ZXJfaW5kZXgoc3RtdCwgcHRyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChpZHggPT09IFZhbHVlcy5FcnJvcikge1xuICAgICAgICAgIHRoaXMuX3dhc20uZmluYWxpemUoc3RtdCk7XG4gICAgICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKGBObyBwYXJhbWV0ZXIgbmFtZWQgJyR7bmFtZX0nLmApO1xuICAgICAgICB9XG4gICAgICAgIHBhcmFtZXRlcnNbaWR4IC0gMV0gPSAodmFsdWVzIGFzIGFueSlba2V5XTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCaW5kIHBhcmFtZXRlcnNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtZXRlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCB2YWx1ZSA9IHBhcmFtZXRlcnNbaV07XG4gICAgICBsZXQgc3RhdHVzO1xuICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcbiAgICAgICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gMSA6IDA7XG4gICAgICAgIC8vIGZhbGwgdGhyb3VnaFxuICAgICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgICAgaWYgKE51bWJlci5pc1NhZmVJbnRlZ2VyKHZhbHVlKSkge1xuICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fd2FzbS5iaW5kX2ludChzdG10LCBpICsgMSwgdmFsdWUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfZG91YmxlKHN0bXQsIGkgKyAxLCB2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiYmlnaW50XCI6XG4gICAgICAgICAgLy8gYmlnaW50IGlzIGJvdW5kIGFzIGEgc3RyaW5nIGFuZCBjb252ZXJ0ZWQgdG8gaTY0IG9uIEMgc2lkZVxuICAgICAgICAgIHNldFN0cih0aGlzLl93YXNtLCB2YWx1ZS50b1N0cmluZygpLCAocHRyKSA9PiB7XG4gICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfYmlnX2ludChzdG10LCBpICsgMSwgcHRyKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcInN0cmluZ1wiOlxuICAgICAgICAgIHNldFN0cih0aGlzLl93YXNtLCB2YWx1ZSwgKHB0cikgPT4ge1xuICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fd2FzbS5iaW5kX3RleHQoc3RtdCwgaSArIDEsIHB0cik7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgLy8gRGF0ZXMgYXJlIGFsbG93ZWQgYW5kIGJvdW5kIHRvIFRFWFQsIGZvcm1hdHRlZCBgWVlZWS1NTS1ERFRISDpNTTpTUy5TU1NaYFxuICAgICAgICAgICAgc2V0U3RyKHRoaXMuX3dhc20sIHZhbHVlLnRvSVNPU3RyaW5nKCksIChwdHIpID0+IHtcbiAgICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fd2FzbS5iaW5kX3RleHQoc3RtdCwgaSArIDEsIHB0cik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSkge1xuICAgICAgICAgICAgLy8gVWludDhBcnJheXMgYXJlIGFsbG93ZWQgYW5kIGJvdW5kIHRvIEJMT0JcbiAgICAgICAgICAgIHNldEFycih0aGlzLl93YXNtLCB2YWx1ZSwgKHB0cikgPT4ge1xuICAgICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfYmxvYihzdG10LCBpICsgMSwgcHRyLCB2YWx1ZS5sZW5ndGgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBCb3RoIG51bGwgYW5kIHVuZGVmaW5lZCByZXN1bHQgaW4gYSBOVUxMIGVudHJ5XG4gICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfbnVsbChzdG10LCBpICsgMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3dhc20uZmluYWxpemUoc3RtdCk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IoYENhbiBub3QgYmluZCAke3R5cGVvZiB2YWx1ZX0uYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgaWYgKHN0YXR1cyAhPT0gU3RhdHVzLlNxbGl0ZU9rKSB7XG4gICAgICAgIHRoaXMuX3dhc20uZmluYWxpemUoc3RtdCk7XG4gICAgICAgIHRocm93IHRoaXMuX2Vycm9yKHN0YXR1cyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3RlcCBvbmNlIHRvIGhhbmRsZSBjYXNlIHdoZXJlIHJlc3VsdCBpcyBlbXB0eVxuICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuX3dhc20uc3RlcChzdG10KTtcbiAgICBzd2l0Y2ggKHN0YXR1cykge1xuICAgICAgY2FzZSBTdGF0dXMuU3FsaXRlRG9uZTpcbiAgICAgICAgdGhpcy5fd2FzbS5maW5hbGl6ZShzdG10KTtcbiAgICAgICAgcmV0dXJuIEVtcHR5O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgU3RhdHVzLlNxbGl0ZVJvdzpcbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgUm93cyh0aGlzLCBzdG10KTtcbiAgICAgICAgdGhpcy5fdHJhbnNhY3Rpb25zLmFkZCh0cmFuc2FjdGlvbik7XG4gICAgICAgIHJldHVybiB0cmFuc2FjdGlvbjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aGlzLl93YXNtLmZpbmFsaXplKHN0bXQpO1xuICAgICAgICB0aHJvdyB0aGlzLl9lcnJvcihzdGF0dXMpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogREIuY2xvc2VcbiAgICpcbiAgICogQ2xvc2UgZGF0YWJhc2UgaGFuZGxlLiBUaGlzIG11c3QgYmUgY2FsbGVkIGlmXG4gICAqIERCIGlzIG5vIGxvbmdlciB1c2VkLCB0byBhdm9pZCBsZWFraW5nIGZpbGVcbiAgICogcmVzb3VyY2VzLlxuICAgKlxuICAgKiBJZiBmb3JjZSBpcyBzcGVjaWZpZWQsIGFueSBvbi1nb2luZyB0cmFuc2FjdGlvbnNcbiAgICogd2lsbCBiZSBjbG9zZWQuXG4gICAqL1xuICBjbG9zZShmb3JjZTogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgaWYgKCF0aGlzLl9vcGVuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChmb3JjZSkge1xuICAgICAgZm9yIChjb25zdCB0cmFuc2FjdGlvbiBvZiB0aGlzLl90cmFuc2FjdGlvbnMpIHtcbiAgICAgICAgdHJhbnNhY3Rpb24ucmV0dXJuKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLl93YXNtLmNsb3NlKCkgIT09IFN0YXR1cy5TcWxpdGVPaykge1xuICAgICAgdGhyb3cgdGhpcy5fZXJyb3IoKTtcbiAgICB9XG4gICAgdGhpcy5fb3BlbiA9IGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIERCLmxhc3RJbnNlcnRSb3dJZFxuICAgKlxuICAgKiBHZXQgbGFzdCBpbnNlcnRlZCByb3cgaWQuIFRoaXMgY29ycmVzcG9uZHMgdG9cbiAgICogdGhlIFNRTGl0ZSBmdW5jdGlvbiBgc3FsaXRlM19sYXN0X2luc2VydF9yb3dpZGAuXG4gICAqIFxuICAgKiBCeSBkZWZhdWx0LCBpdCB3aWxsIHJldHVybiAwIGlmIHRoZXJlIGlzIG5vIHJvd1xuICAgKiBpbnNlcnRlZCB5ZXQuXG4gICAqL1xuICBnZXQgbGFzdEluc2VydFJvd0lkKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3dhc20ubGFzdF9pbnNlcnRfcm93aWQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEQi5jaGFuZ2VzXG4gICAqXG4gICAqIFJldHVybiB0aGUgbnVtYmVyIG9mIHJvd3MgbW9kaWZpZWQsIGluc2VydGVkIG9yXG4gICAqIGRlbGV0ZWQgYnkgdGhlIG1vc3QgcmVjZW50bHkgY29tcGxldGVkIHF1ZXJ5LlxuICAgKiBUaGlzIGNvcnJlc3BvbmRzIHRvIHRoZSBTUUxpdGUgZnVuY3Rpb25cbiAgICogYHNxbGl0ZTNfY2hhbmdlc2AuXG4gICAqL1xuICBnZXQgY2hhbmdlcygpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl93YXNtLmNoYW5nZXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEQi50b3RhbENoYW5nZXNcbiAgICpcbiAgICogUmV0dXJuIHRoZSBudW1iZXIgb2Ygcm93cyBtb2RpZmllZCwgaW5zZXJ0ZWQgb3JcbiAgICogZGVsZXRlZCBzaW5jZSB0aGUgZGF0YWJhc2Ugd2FzIG9wZW5lZC5cbiAgICogVGhpcyBjb3JyZXNwb25kcyB0byB0aGUgU1FMaXRlIGZ1bmN0aW9uXG4gICAqIGBzcWxpdGUzX3RvdGFsX2NoYW5nZXNgLlxuICAgKi9cbiAgZ2V0IHRvdGFsQ2hhbmdlcygpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl93YXNtLnRvdGFsX2NoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2Vycm9yKGNvZGU/OiBudW1iZXIpOiBTcWxpdGVFcnJvciB7XG4gICAgaWYgKGNvZGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29kZSA9IHRoaXMuX3dhc20uZ2V0X3N0YXR1cygpIGFzIG51bWJlcjtcbiAgICB9XG4gICAgY29uc3QgbXNnID0gZ2V0U3RyKHRoaXMuX3dhc20sIHRoaXMuX3dhc20uZ2V0X3NxbGl0ZV9lcnJvcl9zdHIoKSk7XG4gICAgcmV0dXJuIG5ldyBTcWxpdGVFcnJvcihtc2csIGNvZGUpO1xuICB9XG59XG4iXX0=