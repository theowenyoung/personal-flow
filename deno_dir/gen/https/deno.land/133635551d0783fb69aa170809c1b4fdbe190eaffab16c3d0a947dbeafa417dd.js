import * as tools from './tools.ts';
export { tools };
export function makeHackle(options = {}) {
    const stringify = options.stringify || tools.defaultStringify;
    const rejectDefaultScopes = options.rejectDefaultScopes || false;
    const rawScopes = options.additionalScopes || [];
    let logLevel = options.defaultLogLevel || 'debug';
    let loggers = options.loggers || [tools.consoleLogger];
    if (!rejectDefaultScopes)
        rawScopes.unshift(...tools.defaultScopes);
    const scopes = new Map();
    const logStorage = new Map();
    rawScopes.forEach(scope => scopes.set(scope.name, scope));
    function log(scopeName, message) {
        if (!logLevel)
            return;
        const scope = scopes.get(scopeName);
        if (scope === undefined)
            throw new Error(`No scope has been set for '${scopeName}'`);
        const levelMap = {
            error: 5,
            warn: 4,
            notice: 3,
            info: 2,
            debug: 1,
        };
        if (levelMap[scope.level] < levelMap[logLevel])
            return;
        let prettyMessage = ``;
        const defaultProcedure = () => {
            if (scope.prepend)
                message = [scope.prepend, ...message];
            if (scope.append)
                message = [...message, scope.append];
            prettyMessage = stringify(message);
        };
        if (scope.messageMap) {
            const res = scope.messageMap(message);
            if (typeof res === 'string')
                prettyMessage = res;
            else {
                message = res;
                defaultProcedure();
            }
        }
        else
            defaultProcedure();
        if (scope.storeLogs) {
            const previousLogs = logStorage.get(scope.name);
            logStorage.set(scope.name, previousLogs ? [...previousLogs, prettyMessage] : [prettyMessage]);
        }
        loggers.forEach(logger => logger(prettyMessage, scope.level));
    }
    function critical(...message) {
        error(...message);
        if (Deno)
            return Deno.exit();
        else
            throw new Error(`A critical error was encountered`);
    }
    function error(...message) {
        scope('default-error')(...message);
    }
    function warn(...message) {
        scope('default-warn')(...message);
    }
    function notice(...message) {
        scope('default-notice')(...message);
    }
    function info(...message) {
        scope('default-info')(...message);
    }
    function debug(...message) {
        scope('default-debug')(...message);
    }
    function logStack() {
        scope('default-stack')();
    }
    function setLogLevel(level) {
        logLevel = level;
    }
    function setRawLogLevel(level) {
        if (level === 'none')
            setLogLevel(null);
        else if (level === 'error')
            setLogLevel('error');
        else if (level === 'warn')
            setLogLevel('warn');
        else if (level === 'notice')
            setLogLevel('notice');
        else if (level === 'info')
            setLogLevel('info');
        else if (level === 'debug')
            setLogLevel('debug');
        else if (typeof level === 'string')
            error(`An invalid log level was received.  '${level}' is not one of the valid log levels: 'none', 'error', 'warn', 'notice', 'info', and 'debug'.`);
    }
    function addScope(scope) {
        scopes.set(scope.name, scope);
    }
    function scope(scopeName) {
        return (...message) => {
            log(scopeName, message);
        };
    }
    function currentScopes() {
        return Array.from(scopes.values());
    }
    function removeDefaultScopes() {
        Object.values(tools.defaultScopes)
            .map(scope => scope.name)
            .forEach(name => scopes.delete(name));
    }
    function getLogsOnScope(scopeName) {
        return logStorage.get(scopeName) || null;
    }
    function setLoggers(newLoggers) {
        loggers = newLoggers;
    }
    return {
        critical,
        error,
        warn,
        notice,
        info,
        debug,
        logStack,
        setLogLevel,
        setRawLogLevel,
        addScope,
        scope,
        currentScopes,
        removeDefaultScopes,
        getLogsOnScope,
        setLoggers,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sWUFBWSxDQUFBO0FBRW5DLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQTtBQXVGaEIsTUFBTSxVQUFVLFVBQVUsQ0FBQyxVQUE2QixFQUFFO0lBQ3pELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFBO0lBQzdELE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixJQUFJLEtBQUssQ0FBQTtJQUNoRSxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLElBQUksRUFBRSxDQUFBO0lBRWhELElBQUksUUFBUSxHQUFvQixPQUFPLENBQUMsZUFBZSxJQUFJLE9BQU8sQ0FBQTtJQUNsRSxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBR3RELElBQUksQ0FBQyxtQkFBbUI7UUFBRSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBR25FLE1BQU0sTUFBTSxHQUF1QixJQUFJLEdBQUcsRUFBRSxDQUFBO0lBQzVDLE1BQU0sVUFBVSxHQUEwQixJQUFJLEdBQUcsRUFBRSxDQUFBO0lBR25ELFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUV6RCxTQUFTLEdBQUcsQ0FBQyxTQUFpQixFQUFFLE9BQWM7UUFDN0MsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFNO1FBRXJCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDbkMsSUFBSSxLQUFLLEtBQUss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QUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7YUFDaEMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzthQUN4QixPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztJQWVELFNBQVMsY0FBYyxDQUFDLFNBQWlCO1FBQ3hDLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUE7SUFDekMsQ0FBQztJQVdELFNBQVMsVUFBVSxDQUFDLFVBQW9CO1FBQ3ZDLE9BQU8sR0FBRyxVQUFVLENBQUE7SUFDckIsQ0FBQztJQUVELE9BQU87UUFDTixRQUFRO1FBQ1IsS0FBSztRQUNMLElBQUk7UUFDSixNQUFNO1FBQ04sSUFBSTtRQUNKLEtBQUs7UUFDTCxRQUFRO1FBQ1IsV0FBVztRQUNYLGNBQWM7UUFDZCxRQUFRO1FBQ1IsS0FBSztRQUNMLGFBQWE7UUFDYixtQkFBbUI7UUFDbkIsY0FBYztRQUNkLFVBQVU7S0FDVixDQUFBO0FBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHRvb2xzIGZyb20gJy4vdG9vbHMudHMnXG5cbmV4cG9ydCB7IHRvb2xzIH1cblxuZXhwb3J0IHR5cGUgTG9nZ2VyID0gKG1lc3NhZ2U6IHN0cmluZywgbGV2ZWw6IExvZ0xldmVsKSA9PiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxuZXhwb3J0IHR5cGUgTG9nTGV2ZWwgPSAnZXJyb3InIHwgJ3dhcm4nIHwgJ25vdGljZScgfCAnaW5mbycgfCAnZGVidWcnXG5cbmV4cG9ydCBpbnRlcmZhY2UgU2NvcGUge1xuXHQvKipcblx0ICogVGhlIG5hbWUgb2YgdGhhdCBzY29wZS4gIFlvdSBjYW4gbGF0ZXIgdXNlIHRoaXMgbmFtZSB0byBhY2Nlc3MgdGhpcyBzY29wZSB2aWEgdGhlIGBoYWNrbGUuc2NvcGVgIGZ1bmN0aW9uLlxuXHQgKlxuXHQgKiBgYGB0c1xuXHQgKiBoYWNrbGUuYWRkU2NvcGUoe1xuXHQgKiBcdG5hbWU6ICdzb21lLW5hbWUnLFxuXHQgKiBcdC8vIC4uLlxuXHQgKiB9KVxuXHQgKlxuXHQgKiBoYWNrbGUuc2NvcGUoJ3NvbWUtc2NvcGUnKSgnU29tZSBsb2cgbWVzc2FnZScpXG5cdCAqL1xuXHRuYW1lOiBzdHJpbmdcblxuXHQvKipcblx0ICogV2hpY2ggbGV2ZWwgbG9ncyB0byB0aGlzIHNjb3BlIGFyZSB0byBiZSBsb2dnZWQgdG8uXG5cdCAqXG5cdCAqIFByZWNlZGVuY2UgaXMgYXMgZm9sbG93czpcblx0ICogLSBgZXJyb3JgXG5cdCAqIC0gYHdhcm5gXG5cdCAqIC0gYG5vdGljZWBcblx0ICogLSBgaW5mb2Bcblx0ICogLSBgZGVidWdgXG5cdCAqL1xuXHRsZXZlbDogTG9nTGV2ZWxcblxuXHQvKiogVGhpcyB3aWxsIGJlICd1bnNoaWZ0ZWQnIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IG9mIG1lc3NhZ2VzICovXG5cdHByZXBlbmQ/OiBzdHJpbmdcblxuXHQvKiogVGhpcyB3aWxsIGJlICdwdXNoZWQnIHRvIHRoZSBlbmQgb2YgdGhlIGFycmF5IG9mIG1lc3NhZ2VzICovXG5cdGFwcGVuZD86IHN0cmluZ1xuXG5cdC8qKlxuXHQgKiBBbGwgbWVzc2FnZXMgdG8gdGhpcyBzY29wZSB3aWxsIGJlIG1hcHBlZCB0aHJvdWdoIHRoaXMgZnVuY3Rpb24gaWYgaXQgaXMgc3BlY2lmaWVkLlxuXHQgKiBJZiB0aGlzIGl0IHJldHVybnMgYSBzdHJpbmcsICdhcHBlbmQnIGFuZCAncHJlcGVuZCcgd2lsbCBiZSBpZ25vcmVkIGFuZCBIYWNrbGUgd2lsbCBub3Rcblx0ICogYXR0ZW1wdCB0byBzdHJpbmdpZnkgdGhlIG1lc3NhZ2UuICBJZiBhbiBhcnJheSBpcyByZXR1cm5lZCxcblx0ICogdGhlIG5vcm1hbCBwcm9jZWR1cmUgd2lsbCBiZSBhZGhlcmVkIHRvXG5cdCAqL1xuXHRtZXNzYWdlTWFwPzogKG1lc3NhZ2U6IGFueVtdKSA9PiBhbnlbXSB8IHN0cmluZ1xuXG5cdC8qKlxuXHQgKiBJZiBgdHJ1ZWAsIHRoZSBhbGwgdGhlIGxvZ3MgaW4gdGhpcyBzY29wZSB3aWxsIGJlIHN0b3JlZCBmb3IgbGF0ZXIgYWNjZXNzXG5cdCAqIHZpYSB0aGUgYGhhY2tsZS5nZXRTdG9yZWRMb2dzYCBmdW5jdGlvblxuXHQgKiBAZGVmYXVsdCBmYWxzZVxuXHQgKi9cblx0c3RvcmVMb2dzPzogYm9vbGVhblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1ha2VIYWNrbGVPcHRpb25zIHtcblx0LyoqXG5cdCAqIEhvdyB0aGUgbG9nIG1lc3NhZ2UgdG8gYmUgZGlzcGxheWVkXG5cdCAqIEBkZWZhdWx0IHRvb2xzLnN0cmluZ2lmeVxuXHQgKi9cblx0c3RyaW5naWZ5PzogKG1lc3NhZ2U6IGFueVtdKSA9PiBzdHJpbmdcblxuXHQvKipcblx0ICogSG93IHRoZSBtZXNzYWdlIGlzIHRvIGJlIGxvZ2dlZFxuXHQgKiBAZGVmYXVsdCBbdG9vbHMuY29uc29sZUxvZ2dlcl1cblx0ICovXG5cdGxvZ2dlcnM/OiBMb2dnZXJbXVxuXG5cdC8qKlxuXHQgKiBEZWZhdWx0IGxvZyBsZXZlbFxuXHQgKiBAZGVmYXVsdCAnZGVidWcnXG5cdCAqL1xuXHRkZWZhdWx0TG9nTGV2ZWw/OiBMb2dMZXZlbFxuXG5cdC8qKlxuXHQgKiBBZGRpdGlvbmFsIHNjb3BlcyB0aGF0IGNhbiBiZSBhY2Nlc3NlZCB3aXRoIHRoZSBgaGFja2xlLnNjb3BlYCBmdW5jdGlvblxuXHQgKiBAZGVmYXVsdCBbXVxuXHQgKi9cblx0YWRkaXRpb25hbFNjb3Blcz86IFNjb3BlW11cblxuXHQvKipcblx0ICogSWYgdHJ1ZSBoYWNrbGUgd2lsbCBub3QgdXNlIHRoZSBkZWZhdWx0IHNjb3BlcyBkZWZpbmVkIGluIGB0b29scy5kZWZhdWx0U2NvcGVzYFxuXHQgKiBAZGVmYXVsdCBmYWxzZVxuXHQgKi9cblx0cmVqZWN0RGVmYXVsdFNjb3Blcz86IGJvb2xlYW5cbn1cblxuZXhwb3J0IHR5cGUgSGFja2xlID0gUmV0dXJuVHlwZTx0eXBlb2YgbWFrZUhhY2tsZT5cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VIYWNrbGUob3B0aW9uczogTWFrZUhhY2tsZU9wdGlvbnMgPSB7fSkge1xuXHRjb25zdCBzdHJpbmdpZnkgPSBvcHRpb25zLnN0cmluZ2lmeSB8fCB0b29scy5kZWZhdWx0U3RyaW5naWZ5XG5cdGNvbnN0IHJlamVjdERlZmF1bHRTY29wZXMgPSBvcHRpb25zLnJlamVjdERlZmF1bHRTY29wZXMgfHwgZmFsc2Vcblx0Y29uc3QgcmF3U2NvcGVzID0gb3B0aW9ucy5hZGRpdGlvbmFsU2NvcGVzIHx8IFtdXG5cblx0bGV0IGxvZ0xldmVsOiBMb2dMZXZlbCB8IG51bGwgPSBvcHRpb25zLmRlZmF1bHRMb2dMZXZlbCB8fCAnZGVidWcnXG5cdGxldCBsb2dnZXJzID0gb3B0aW9ucy5sb2dnZXJzIHx8IFt0b29scy5jb25zb2xlTG9nZ2VyXVxuXG5cdC8vIE1vdW50IHRoZSBkZWZhdWx0IHNjb3BlcyBpZiBhbGxvd2VkXG5cdGlmICghcmVqZWN0RGVmYXVsdFNjb3BlcykgcmF3U2NvcGVzLnVuc2hpZnQoLi4udG9vbHMuZGVmYXVsdFNjb3BlcylcblxuXHQvLyBDcmVhdGUgb3V0IHN0b3JhZ2UgbWFwcyBmb3IgZWFzeSBhY2Nlc3MgbGF0ZXJcblx0Y29uc3Qgc2NvcGVzOiBNYXA8c3RyaW5nLCBTY29wZT4gPSBuZXcgTWFwKClcblx0Y29uc3QgbG9nU3RvcmFnZTogTWFwPHN0cmluZywgc3RyaW5nW10+ID0gbmV3IE1hcCgpXG5cblx0Ly8gUG9wdWxhdGUgdGhlIHNjb3BlcyBtYXBcblx0cmF3U2NvcGVzLmZvckVhY2goc2NvcGUgPT4gc2NvcGVzLnNldChzY29wZS5uYW1lLCBzY29wZSkpXG5cblx0ZnVuY3Rpb24gbG9nKHNjb3BlTmFtZTogc3RyaW5nLCBtZXNzYWdlOiBhbnlbXSkge1xuXHRcdGlmICghbG9nTGV2ZWwpIHJldHVyblxuXG5cdFx0Y29uc3Qgc2NvcGUgPSBzY29wZXMuZ2V0KHNjb3BlTmFtZSlcblx0XHRpZiAoc2NvcGUgPT09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKGBObyBzY29wZSBoYXMgYmVlbiBzZXQgZm9yICcke3Njb3BlTmFtZX0nYClcblxuXHRcdGNvbnN0IGxldmVsTWFwID0ge1xuXHRcdFx0ZXJyb3I6IDUsXG5cdFx0XHR3YXJuOiA0LFxuXHRcdFx0bm90aWNlOiAzLFxuXHRcdFx0aW5mbzogMixcblx0XHRcdGRlYnVnOiAxLFxuXHRcdH1cblxuXHRcdGlmIChsZXZlbE1hcFtzY29wZS5sZXZlbF0gPCBsZXZlbE1hcFtsb2dMZXZlbF0pIHJldHVyblxuXG5cdFx0bGV0IHByZXR0eU1lc3NhZ2UgPSBgYFxuXG5cdFx0Y29uc3QgZGVmYXVsdFByb2NlZHVyZSA9ICgpID0+IHtcblx0XHRcdGlmIChzY29wZS5wcmVwZW5kKSBtZXNzYWdlID0gW3Njb3BlLnByZXBlbmQsIC4uLm1lc3NhZ2VdXG5cdFx0XHRpZiAoc2NvcGUuYXBwZW5kKSBtZXNzYWdlID0gWy4uLm1lc3NhZ2UsIHNjb3BlLmFwcGVuZF1cblxuXHRcdFx0cHJldHR5TWVzc2FnZSA9IHN0cmluZ2lmeShtZXNzYWdlKVxuXHRcdH1cblxuXHRcdGlmIChzY29wZS5tZXNzYWdlTWFwKSB7XG5cdFx0XHRjb25zdCByZXMgPSBzY29wZS5tZXNzYWdlTWFwKG1lc3NhZ2UpXG5cdFx0XHRpZiAodHlwZW9mIHJlcyA9PT0gJ3N0cmluZycpIHByZXR0eU1lc3NhZ2UgPSByZXNcblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRtZXNzYWdlID0gcmVzXG5cdFx0XHRcdGRlZmF1bHRQcm9jZWR1cmUoKVxuXHRcdFx0fVxuXHRcdH0gZWxzZSBkZWZhdWx0UHJvY2VkdXJlKClcblxuXHRcdGlmIChzY29wZS5zdG9yZUxvZ3MpIHtcblx0XHRcdGNvbnN0IHByZXZpb3VzTG9ncyA9IGxvZ1N0b3JhZ2UuZ2V0KHNjb3BlLm5hbWUpXG5cdFx0XHRsb2dTdG9yYWdlLnNldChzY29wZS5uYW1lLCBwcmV2aW91c0xvZ3MgPyBbLi4ucHJldmlvdXNMb2dzLCBwcmV0dHlNZXNzYWdlXSA6IFtwcmV0dHlNZXNzYWdlXSlcblx0XHR9XG5cblx0XHRsb2dnZXJzLmZvckVhY2gobG9nZ2VyID0+IGxvZ2dlcihwcmV0dHlNZXNzYWdlLCBzY29wZS5sZXZlbCkpXG5cdH1cblxuXHQvKiogTG9ncyBhIG1lc3NhZ2UgdG8gdGhlICdlcnJvcicgbGV2ZWwgYW5kIGV4aXRzICovXG5cdGZ1bmN0aW9uIGNyaXRpY2FsKC4uLm1lc3NhZ2U6IGFueVtdKTogbmV2ZXIge1xuXHRcdGVycm9yKC4uLm1lc3NhZ2UpXG5cdFx0aWYgKERlbm8pIHJldHVybiBEZW5vLmV4aXQoKVxuXHRcdGVsc2UgdGhyb3cgbmV3IEVycm9yKGBBIGNyaXRpY2FsIGVycm9yIHdhcyBlbmNvdW50ZXJlZGApXG5cdH1cblxuXHQvKiogTG9ncyBtZXNzYWdlIHRvIHRoZSAnZXJyb3InIGxldmVsICovXG5cdGZ1bmN0aW9uIGVycm9yKC4uLm1lc3NhZ2U6IGFueVtdKSB7XG5cdFx0c2NvcGUoJ2RlZmF1bHQtZXJyb3InKSguLi5tZXNzYWdlKVxuXHR9XG5cblx0LyoqIExvZ3MgbWVzc2FnZSB0byB0aGUgJ3dhcm4nIGxldmVsICovXG5cdGZ1bmN0aW9uIHdhcm4oLi4ubWVzc2FnZTogYW55W10pIHtcblx0XHRzY29wZSgnZGVmYXVsdC13YXJuJykoLi4ubWVzc2FnZSlcblx0fVxuXG5cdC8qKiBMb2dzIG1lc3NhZ2UgdG8gdGhlICdub3RpY2UnIGxldmVsICovXG5cdGZ1bmN0aW9uIG5vdGljZSguLi5tZXNzYWdlOiBhbnlbXSkge1xuXHRcdHNjb3BlKCdkZWZhdWx0LW5vdGljZScpKC4uLm1lc3NhZ2UpXG5cdH1cblxuXHQvKiogTG9ncyBtZXNzYWdlIHRvIHRoZSAnaW5mbycgbGV2ZWwgKi9cblx0ZnVuY3Rpb24gaW5mbyguLi5tZXNzYWdlOiBhbnlbXSkge1xuXHRcdHNjb3BlKCdkZWZhdWx0LWluZm8nKSguLi5tZXNzYWdlKVxuXHR9XG5cblx0LyoqIExvZ3MgbWVzc2FnZSB0byB0aGUgJ2RlYnVnJyBsZXZlbCAqL1xuXHRmdW5jdGlvbiBkZWJ1ZyguLi5tZXNzYWdlOiBhbnlbXSkge1xuXHRcdHNjb3BlKCdkZWZhdWx0LWRlYnVnJykoLi4ubWVzc2FnZSlcblx0fVxuXG5cdC8qKlxuXHQgKiBMb2dzIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgdG8gdGhlICdkZWJ1ZycgbGV2ZWxcblx0ICpcblx0ICogYGBgdHNcblx0ICogaGFja2xlLmxvZ1N0YWNrKClcblx0ICogYGBgXG5cdCAqL1xuXHRmdW5jdGlvbiBsb2dTdGFjaygpIHtcblx0XHRzY29wZSgnZGVmYXVsdC1zdGFjaycpKClcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSBsb2cgbGV2ZWwgdG8gdGhlIHZhbHVlIG9mICdsZXZlbCcuXG5cdCAqIE9ubHkgbG9ncyB0aGF0IGFyZSBlcXVhbCB0byBvciBoaWdoZXIgdGhhbiB0aGUgc2V0IGxldmVsIHdpbGwgYmUgbG9nZ2VkLlxuXHQgKlxuXHQgKiBMZXZlbCBvcmRlcjpcblx0ICogLSBgZXJyb3JgXG5cdCAqIC0gYHdhcm5gXG5cdCAqIC0gYG5vdGljZWBcblx0ICogLSBgaW5mb2Bcblx0ICogLSBgZGVidWdgXG5cdCAqXG5cdCAqIFNvIGlmIEkgc2V0IHRoZSBsb2cgbGV2ZWwgdG8gYHdhcm5gLi4uXG5cdCAqXG5cdCAqIGBgYHRzXG5cdCAqIGhhY2tsZS5zZXRMb2dMZXZlbCgnd2FybicpXG5cdCAqXG5cdCAqIGhhY2tsZS5lcnJvcignc29tZSBlcnJvcicpXG5cdCAqIGhhY2tsZS53YXJuKCdzb21lIHdhcm4nKVxuXHQgKiBoYWNrbGUubm90aWNlKCdzb21lIG5vdGljZScpXG5cdCAqIGhhY2tsZS5pbmZvKCdzb21lIGluZm8nKVxuXHQgKiBgYGBcblx0ICpcblx0ICogLi4ub25seSBlcnJvcnMgYW5kIHdhcm5pbmdzIHdpbGwgYXBwZWFyIG9uIHRoZSBjb25zb2xlLlxuXHQgKlxuXHQgKiBgYGBcblx0ICogc29tZSBlcnJvclxuXHQgKiBzb21lIHdhcm5cblx0ICogYGBgXG5cdCAqL1xuXHRmdW5jdGlvbiBzZXRMb2dMZXZlbChsZXZlbDogTG9nTGV2ZWwgfCBudWxsKSB7XG5cdFx0bG9nTGV2ZWwgPSBsZXZlbFxuXHR9XG5cblx0LyoqXG5cdCAqIEp1c3QgYSB3cmFwcGVyIGFyb3VuZCBgaGFja2xlLnNldExvZ0xldmVsYCBleGNlcHQgaXQgdmFsaWRhdGVzIHRoZSBsZXZlbCBmaXJzdC5cblx0ICogTk9URTogVGhlIHN0cmluZyBgbm9uZWAgY291bnRzIGFzIGBoYWNrbGUuc2V0TG9nTGV2ZWwobnVsbClgLiAgTm9uLXN0cmluZyB2YWx1ZXMgYXJlIGlnbm9yZWQuXG5cdCAqXG5cdCAqIFRoZSBpbnRlbmRlZCB1c2FnZSBmb3IgdGhpcyBmdW5jdGlvbiBpcyB0byBtYWtlIGl0IGVhc2llciB0byBzZXQgdGhlIGxvZyBsZXZlbCBzdHJhaWdodCBmcm9tIGEgQ0xJIG9wdGlvbi5cblx0ICpcblx0ICogSGVyZSBpcyBhbiBleGFtcGxlIHVzaW5nIGBjbWRgOlxuXHQgKiBgYGB0c1xuXHQgKiBjb25zdCBwcm9ncmFtID0gbmV3IENvbW1hbmQoKVxuXHQgKiBwcm9ncmFtLm9wdGlvbignLS1sb2ctbGV2ZWwgPGxldmVsPicpXG5cdCAqIHByb2dyYW0ucGFyc2UoRGVuby5hcmdzKVxuXHQgKlxuXHQgKiBoYWNrbGUuc2V0UmF3TG9nTGV2ZWwocHJvZ3JhbS5sb2dMZXZlbClcblx0ICogYGBgXG5cdCAqL1xuXHRmdW5jdGlvbiBzZXRSYXdMb2dMZXZlbChsZXZlbDogYW55KSB7XG5cdFx0aWYgKGxldmVsID09PSAnbm9uZScpIHNldExvZ0xldmVsKG51bGwpXG5cdFx0ZWxzZSBpZiAobGV2ZWwgPT09ICdlcnJvcicpIHNldExvZ0xldmVsKCdlcnJvcicpXG5cdFx0ZWxzZSBpZiAobGV2ZWwgPT09ICd3YXJuJykgc2V0TG9nTGV2ZWwoJ3dhcm4nKVxuXHRcdGVsc2UgaWYgKGxldmVsID09PSAnbm90aWNlJykgc2V0TG9nTGV2ZWwoJ25vdGljZScpXG5cdFx0ZWxzZSBpZiAobGV2ZWwgPT09ICdpbmZvJykgc2V0TG9nTGV2ZWwoJ2luZm8nKVxuXHRcdGVsc2UgaWYgKGxldmVsID09PSAnZGVidWcnKSBzZXRMb2dMZXZlbCgnZGVidWcnKVxuXHRcdGVsc2UgaWYgKHR5cGVvZiBsZXZlbCA9PT0gJ3N0cmluZycpXG5cdFx0XHRlcnJvcihcblx0XHRcdFx0YEFuIGludmFsaWQgbG9nIGxldmVsIHdhcyByZWNlaXZlZC4gICcke2xldmVsfScgaXMgbm90IG9uZSBvZiB0aGUgdmFsaWQgbG9nIGxldmVsczogJ25vbmUnLCAnZXJyb3InLCAnd2FybicsICdub3RpY2UnLCAnaW5mbycsIGFuZCAnZGVidWcnLmBcblx0XHRcdClcblx0fVxuXG5cdC8qKlxuXHQgKiBBZGRzIGEgY3VzdG9tIHNjb3BlIHRoYXQgY2FuIGJlIGxhdGVyIGFjY2Vzc2VkIHdpdGggdGhlIGBoYWNrbGUuc2NvcGVgIGZ1bmN0aW9uLlxuXHQgKlxuXHQgKiBgYGB0c1xuXHQgKiBoYWNrbGUuYWRkU2NvcGUoe1xuXHQgKiBcdG5hbWU6ICdteS1zY29wZScsXG5cdCAqIFx0bGV2ZWw6ICdub3RpY2UnLFxuXHQgKiBcdHByZXBlbmQ6ICdteVNjb3BlOiAnLFxuXHQgKiB9KVxuXHQgKlxuXHQgKiBjb25zdCBsb2cgPSBoYWNrbGUuc2NvcGUoJ215LXNjb3BlJylcblx0ICpcblx0ICogbG9nKCdoZWxsbyB0aGVyZScpIC8vIC0+IG15U2NvcGU6IGhlbGxvIHRoZXJlXG5cdCAqIGBgYFxuXHQgKi9cblx0ZnVuY3Rpb24gYWRkU2NvcGUoc2NvcGU6IFNjb3BlKSB7XG5cdFx0c2NvcGVzLnNldChzY29wZS5uYW1lLCBzY29wZSlcblx0fVxuXG5cdC8qKlxuXHQgKiBBY3RpdmF0ZXMgYSBjZXJ0YWluIHNjb3BlLlxuXHQgKlxuXHQgKiBgYGB0c1xuXHQgKiBoYWNrbGUuYWRkU2NvcGUoe1xuXHQgKiBcdG5hbWU6ICdteS1zY29wZScsXG5cdCAqIFx0bGV2ZWw6ICdub3RpY2UnLFxuXHQgKiBcdHByZXBlbmQ6ICdteVNjb3BlOiAnLFxuXHQgKiB9KVxuXHQgKlxuXHQgKiBjb25zdCBsb2cgPSBoYWNrbGUuc2NvcGUoJ215LXNjb3BlJylcblx0ICpcblx0ICogbG9nKCdoZWxsbyB0aGVyZScpIC8vIC0+IG15U2NvcGU6IGhlbGxvIHRoZXJlXG5cdCAqIGBgYFxuXHQgKi9cblx0ZnVuY3Rpb24gc2NvcGUoc2NvcGVOYW1lOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gKC4uLm1lc3NhZ2U6IGFueVtdKSA9PiB7XG5cdFx0XHRsb2coc2NvcGVOYW1lLCBtZXNzYWdlKVxuXHRcdH1cblx0fVxuXG5cdC8qKiBHZXQgdGhlIGN1cnJlbnRseSB1c2VkIHNjb3BlcyAqL1xuXHRmdW5jdGlvbiBjdXJyZW50U2NvcGVzKCk6IFNjb3BlW10ge1xuXHRcdHJldHVybiBBcnJheS5mcm9tKHNjb3Blcy52YWx1ZXMoKSlcblx0fVxuXG5cdC8qKiBSZW1vdmVzIHRoZSBkZWZhdWx0IHNjb3BlcyAqL1xuXHRmdW5jdGlvbiByZW1vdmVEZWZhdWx0U2NvcGVzKCkge1xuXHRcdE9iamVjdC52YWx1ZXModG9vbHMuZGVmYXVsdFNjb3Blcylcblx0XHRcdC5tYXAoc2NvcGUgPT4gc2NvcGUubmFtZSlcblx0XHRcdC5mb3JFYWNoKG5hbWUgPT4gc2NvcGVzLmRlbGV0ZShuYW1lKSlcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgdGhlIGxvZ3MgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiBsb2dnZWQgb24gYHNjb3BlTmFtZWBcblx0ICpcblx0ICogQHJldHVybnMgYG51bGxgIGlmIGBzdG9yZUxvZ3NgIGlzIG5vdCBzZXQgdG8gYHRydWVgIG9uIHRoZSBwYXJ0aWN1bGFyIHNjb3BlXG5cdCAqXG5cdCAqIGBgYHRzXG5cdCAqIGhhY2tsZS5lcnJvcignU29tZSBlcnJvcicpIC8vIHVzZXMgdGhlICdkZWZhdWx0LWVycm9yJyBzY29wZSBiZWhpbmQgdGhlIHNjZW5lc1xuXHQgKlxuXHQgKiBjb25zdCBsb2dzID0gaGFja2xlLmdldExvZ3NPblNjb3BlKCdkZWZhdWx0LWVycm9yJylcblx0ICpcblx0ICogc3RyaXBDb2xvcihsb2dzWzBdKSAvLyAtPiAnZXJyb3I6IFNvbWUgZXJyb3InXG5cdCAqIGBgYFxuXHQgKi9cblx0ZnVuY3Rpb24gZ2V0TG9nc09uU2NvcGUoc2NvcGVOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB8IG51bGwge1xuXHRcdHJldHVybiBsb2dTdG9yYWdlLmdldChzY29wZU5hbWUpIHx8IG51bGxcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSBsb2dnZXJzIHRvIGJlIHVzZWRcblx0ICpcblx0ICogYGBgdHNcblx0ICogaGFja2xlLmVycm9yKCdlcnJvciBmb3IgY29uc29sZScpXG5cdCAqXG5cdCAqIGhhY2tsZS5zZXRMb2dnZXJzKHRvb2xzLm1ha2VGaWxlTG9nZ2VyKCcubG9nJykpXG5cdCAqIGhhY2tsZS5lcnJvcignZXJyb3IgZm9yIGZpbGUnKVxuXHQgKi9cblx0ZnVuY3Rpb24gc2V0TG9nZ2VycyhuZXdMb2dnZXJzOiBMb2dnZXJbXSkge1xuXHRcdGxvZ2dlcnMgPSBuZXdMb2dnZXJzXG5cdH1cblxuXHRyZXR1cm4ge1xuXHRcdGNyaXRpY2FsLFxuXHRcdGVycm9yLFxuXHRcdHdhcm4sXG5cdFx0bm90aWNlLFxuXHRcdGluZm8sXG5cdFx0ZGVidWcsXG5cdFx0bG9nU3RhY2ssXG5cdFx0c2V0TG9nTGV2ZWwsXG5cdFx0c2V0UmF3TG9nTGV2ZWwsXG5cdFx0YWRkU2NvcGUsXG5cdFx0c2NvcGUsXG5cdFx0Y3VycmVudFNjb3Blcyxcblx0XHRyZW1vdmVEZWZhdWx0U2NvcGVzLFxuXHRcdGdldExvZ3NPblNjb3BlLFxuXHRcdHNldExvZ2dlcnMsXG5cdH1cbn1cbiJdfQ==