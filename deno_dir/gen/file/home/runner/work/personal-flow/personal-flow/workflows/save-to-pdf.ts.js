import { Base64 } from 'https://deno.land/x/bb64@1.1.0/mod.ts';
import puppeteer from "https://deno.land/x/puppeteer@9.0.2/mod.ts";
export default async function (item, ctx) {
    let browser = null;
    let page = null;
    const getBrowser = async () => {
        if (browser)
            return browser;
        browser = await puppeteer.launch({
            devtools: false,
            defaultViewport: { width: 1370, height: 1200 },
            args: ["--lang=zh-Hans,zh", "--disable-gpu"],
        });
        browser.on("disconnected", () => (browser = null));
        return browser;
    };
    const getNewPage = async (url, force) => {
        if (page)
            return page;
        browser = await getBrowser();
        const pages = await browser.pages();
        if (pages[0] && !force) {
            page = pages[0];
        }
        else {
            page = await browser.newPage();
        }
        await page.setUserAgent("Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36");
        await page.goto(url, { waitUntil: "domcontentloaded" });
        await page.waitForTimeout(4000);
        return page;
    };
    const link = item.links[0].href;
    page = await getNewPage(link, false);
    let b64encoded = "";
    if (page) {
        await autoScroll(page);
        await removeAllLinks(page);
        let scale = 1.6;
        if (link.startsWith("https://news.ycombinator.com")) {
            scale = 2.0;
        }
        const result = await page.pdf({ scale: scale, format: 'a4', omitBackground: true });
        b64encoded = Base64.fromUint8Array(result).toString();
    }
    if (page) {
        await page.close();
    }
    if (browser) {
        await browser.close();
    }
    const title = item.title.value.trim();
    if (b64encoded) {
        const payload = {
            AdvanceErrorHandling: true,
            SandboxMode: false,
            "Messages": [
                {
                    "From": {
                        "Email": ctx.env.FROM_EMAIL,
                        "Name": "Kindle"
                    },
                    "To": [
                        {
                            "Email": ctx.env.TO_EMAIL,
                            "Name": "Try"
                        }
                    ],
                    "Subject": title,
                    "TextPart": item.comments,
                    "CustomID": item.id,
                    "Attachments": [
                        {
                            "Filename": `${title}.pdf`,
                            "ContentType": "application/pdf",
                            "Base64Content": b64encoded
                        }
                    ]
                }
            ]
        };
        return (payload);
    }
    else {
        throw new Error('save pdf error');
    }
}
async function removeAllLinks(page) {
    await page.evaluate(async () => {
        await new Promise((resolve) => {
            const all_links = document.body.getElementsByTagName("a");
            for (let i = 0; i < all_links.length; i++) {
                all_links[i].removeAttribute("href");
            }
            resolve(true);
        });
    });
}
async function autoScroll(page) {
    await page.evaluate(async () => {
        await new Promise((resolve) => {
            let totalHeight = 0;
            const distance = 100;
            const timeout = 8000;
            const now = Date.now();
            const timer = setInterval(() => {
                const scrollHeight = document.body.scrollHeight;
                window.scrollBy(0, distance);
                totalHeight += distance;
                const newNow = Date.now();
                if (newNow - now > timeout) {
                    clearInterval(timer);
                    resolve(true);
                    return;
                }
                if (totalHeight >= scrollHeight) {
                    clearInterval(timer);
                    resolve(true);
                }
            }, 100);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2F2ZS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzYXZlLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDN0QsT0FBTyxTQUdOLE1BQU0sNENBQTRDLENBQUM7QUFFcEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFdBQVcsSUFBMkMsRUFBQyxHQUFpQjtJQUMxRixJQUFJLE9BQU8sR0FBbUIsSUFBSSxDQUFDO0lBQ25DLElBQUksSUFBSSxHQUFnQixJQUFJLENBQUM7SUFDN0IsTUFBTSxVQUFVLEdBQUcsS0FBSyxJQUFJLEVBQUU7UUFDNUIsSUFBSSxPQUFPO1lBQUUsT0FBTyxPQUFPLENBQUM7UUFDNUIsT0FBTyxHQUFHLE1BQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUMvQixRQUFRLEVBQUUsS0FBSztZQUVmLGVBQWUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtZQUM5QyxJQUFJLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxlQUFlLENBQUM7U0FDN0MsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNuRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDLENBQUM7SUFFRixNQUFNLFVBQVUsR0FBRyxLQUFLLEVBQUUsR0FBVSxFQUFDLEtBQWMsRUFBaUIsRUFBRTtRQUNwRSxJQUFJLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUN0QixPQUFPLEdBQUcsTUFBTSxVQUFVLEVBQUUsQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFB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QUM7b0JBQzNCLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNqQjtZQUNMLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtCYXNlNjR9IGZyb20gJ2h0dHBzOi8vZGVuby5sYW5kL3gvYmI2NEAxLjEuMC9tb2QudHMnO1xuaW1wb3J0IHB1cHBldGVlciwge1xuICBCcm93c2VyLFxuICBQYWdlLFxufSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9wdXBwZXRlZXJAOS4wLjIvbW9kLnRzXCI7XG5pbXBvcnQgdHlwZSB7UHVibGljQ29udGV4dH0gZnJvbSAnaHR0cHM6Ly9kZW5vLmxhbmQveC9kZW5vZmxvd0AwLjAuMjcvbW9kLnRzJztcbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChpdGVtOlJlY29yZDxzdHJpbmcsUmVjb3JkPHN0cmluZyxzdHJpbmc+W10+LGN0eDpQdWJsaWNDb250ZXh0KSB7ICBcbiAgbGV0IGJyb3dzZXI6IEJyb3dzZXIgfCBudWxsID0gbnVsbDtcbiAgbGV0IHBhZ2U6IFBhZ2UgfCBudWxsID0gbnVsbDtcbiAgY29uc3QgZ2V0QnJvd3NlciA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoYnJvd3NlcikgcmV0dXJuIGJyb3dzZXI7XG4gICAgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlci5sYXVuY2goe1xuICAgICAgZGV2dG9vbHM6IGZhbHNlLFxuICAgICAgLy8gaGVhZGxlc3M6ICFpc0RldixcbiAgICAgIGRlZmF1bHRWaWV3cG9ydDogeyB3aWR0aDogMTM3MCwgaGVpZ2h0OiAxMjAwIH0sXG4gICAgICBhcmdzOiBbXCItLWxhbmc9emgtSGFucyx6aFwiLCBcIi0tZGlzYWJsZS1ncHVcIl0sXG4gICAgfSk7XG4gICAgYnJvd3Nlci5vbihcImRpc2Nvbm5lY3RlZFwiLCAoKSA9PiAoYnJvd3NlciA9IG51bGwpKTtcbiAgICByZXR1cm4gYnJvd3NlcjtcbiAgfTtcblxuICBjb25zdCBnZXROZXdQYWdlID0gYXN5bmMgKHVybDpzdHJpbmcsZm9yY2U6IGJvb2xlYW4pOiBQcm9taXNlPFBhZ2U+ID0+IHtcbiAgICBpZiAocGFnZSkgcmV0dXJuIHBhZ2U7XG4gICAgYnJvd3NlciA9IGF3YWl0IGdldEJyb3dzZXIoKTtcbiAgICBjb25zdCBwYWdlcyA9IGF3YWl0IGJyb3dzZXIucGFnZXMoKTtcbiAgICBpZiAocGFnZXNbMF0gJiYgIWZvcmNlKSB7XG4gICAgICBwYWdlID0gcGFnZXNbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhZ2UgPSBhd2FpdCBicm93c2VyLm5ld1BhZ2UoKTtcbiAgICB9XG4gICAgYXdhaXQgcGFnZS5zZXRVc2VyQWdlbnQoXG4gICAgICBcIk1vemlsbGEvNS4wIChYMTE7IExpbnV4IHg4Nl82NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzc4LjAuMzkwNC4xMDggU2FmYXJpLzUzNy4zNlwiXG4gICAgKTtcbiAgICAvLyBhd2FpdCBwYWdlLnNldFZpZXdwb3J0KHsgd2lkdGg6IDEzNzAsIGhlaWdodDogMTIwMCB9KTtcbiAgICBhd2FpdCBwYWdlLmdvdG8odXJsLCB7IHdhaXRVbnRpbDogXCJkb21jb250ZW50bG9hZGVkXCIgfSk7XG5cbiAgICBhd2FpdCBwYWdlLndhaXRGb3JUaW1lb3V0KDQwMDApO1xuICAgIC8vIGF3YWl0IHBhZ2Uuc2NyZWVuc2hvdCh7IHBhdGg6IFwiZXhhbXBsZS5wbmdcIiB9KTtcblxuICAgIHJldHVybiBwYWdlO1xuICB9O1xuICBjb25zdCBsaW5rID0gaXRlbS5saW5rc1swXS5ocmVmIGFzIHN0cmluZzsgIFxuICAgIHBhZ2UgPSBhd2FpdCBnZXROZXdQYWdlKGxpbmssZmFsc2UpO1xuICBsZXQgYjY0ZW5jb2RlZCAgPSBcIlwiO1xuICBpZihwYWdlKXtcblxuICAgYXdhaXQgYXV0b1Njcm9sbChwYWdlKTtcblxuICAgYXdhaXQgcmVtb3ZlQWxsTGlua3MocGFnZSk7XG4gICBsZXQgc2NhbGUgPSAxLjY7XG5cbiAgIGlmKGxpbmsuc3RhcnRzV2l0aChcImh0dHBzOi8vbmV3cy55Y29tYmluYXRvci5jb21cIikpe1xuICAgICBzY2FsZSA9IDIuMDtcbiAgIH1cblxuICAgIC8vIHNhdmUgXG4gICAgLy8gcGF0aDogJy4vY2hhbmdlZC90ZXN0LnBkZidcbiAgIGNvbnN0IHJlc3VsdCA9ICBhd2FpdCBwYWdlLnBkZih7c2NhbGU6c2NhbGUsIGZvcm1hdDogJ2E0JyxvbWl0QmFja2dyb3VuZDp0cnVlIH0pO1xuICAgXG4gICAgLy8gZ2V0IGJhc2U2NFxuICAgIC8vIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoJ3V0Zi04Jyk7XG4gICAgIGI2NGVuY29kZWQgPUJhc2U2NC5mcm9tVWludDhBcnJheShyZXN1bHQpLnRvU3RyaW5nKCk7XG5cbiAgfVxuXG4gIGlmIChwYWdlKSB7XG4gICAgYXdhaXQgcGFnZS5jbG9zZSgpO1xuICB9XG4gIC8vIHF1aXQgcHVwcGV0ZWVyXG4gIGlmIChicm93c2VyKSB7XG4gICAgYXdhaXQgKGJyb3dzZXIgYXMgQnJvd3NlcikhLmNsb3NlKCk7XG4gIH1cbiAgLy8gY29uc3QgdGl0bGUgPSBcInRlc3RcIjtcbiAgY29uc3QgdGl0bGUgPSAoaXRlbS50aXRsZSBhcyB1bmtub3duIGFzIFJlY29yZDxzdHJpbmcsc3RyaW5nPikudmFsdWUudHJpbSgpO1xuICBcbiAgaWYoYjY0ZW5jb2RlZCl7XG4gICAgY29uc3QgcGF5bG9hZCA9ICB7XG4gICAgICBBZHZhbmNlRXJyb3JIYW5kbGluZzp0cnVlLFxuICAgICAgU2FuZGJveE1vZGU6ZmFsc2UsXG4gICAgICBcIk1lc3NhZ2VzXCI6W1xuICAgICAgICB7XG4gICAgICAgICAgXCJGcm9tXCI6IHtcbiAgICAgICAgICAgIFwiRW1haWxcIjogY3R4LmVudi5GUk9NX0VNQUlMLFxuICAgICAgICAgICAgXCJOYW1lXCI6IFwiS2luZGxlXCJcbiAgICAgICAgICB9LFxuICAgICAgICAgIFwiVG9cIjogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBcIkVtYWlsXCI6IGN0eC5lbnYuVE9fRU1BSUwsXG4gICAgICAgICAgICAgIFwiTmFtZVwiOiBcIlRyeVwiXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXSxcbiAgICAgICAgICBcIlN1YmplY3RcIjogdGl0bGUsXG4gICAgICAgICAgXCJUZXh0UGFydFwiOiBpdGVtLmNvbW1lbnRzLFxuICAgICAgICAgIFwiQ3VzdG9tSURcIjogaXRlbS5pZCwgIFxuICAgICAgICAgIFwiQXR0YWNobWVudHNcIjpbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFwiRmlsZW5hbWVcIjpgJHt0aXRsZX0ucGRmYCxcbiAgICAgICAgICAgICAgXCJDb250ZW50VHlwZVwiOlwiYXBwbGljYXRpb24vcGRmXCIsXG4gICAgICAgICAgICAgIFwiQmFzZTY0Q29udGVudFwiOmI2NGVuY29kZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9ICAgIFxuICAgIHJldHVybiAocGF5bG9hZCk7XG4gIH1lbHNle1xuICAgIHRocm93IG5ldyBFcnJvcignc2F2ZSBwZGYgZXJyb3InKVxuICB9XG5cbn1cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFsbExpbmtzKHBhZ2U6UGFnZSl7XG4gIGF3YWl0IHBhZ2UuZXZhbHVhdGUoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gIC8vIEB0cy1pZ25vcmU6IHNjcm9sbFRvIGlzIG5vdCBhIGZ1bmN0aW9uXG4gIGNvbnN0IGFsbF9saW5rcyA9IGRvY3VtZW50LmJvZHkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJhXCIpO1xuXG4gIGZvcihsZXQgaT0wOyBpPGFsbF9saW5rcy5sZW5ndGg7IGkrKyl7XG4gICAgICBhbGxfbGlua3NbaV0ucmVtb3ZlQXR0cmlidXRlKFwiaHJlZlwiKTtcbiAgfVxuICByZXNvbHZlKHRydWUpO1xuICAgIH0pO1xufSk7XG5cblxufVxuYXN5bmMgZnVuY3Rpb24gYXV0b1Njcm9sbChwYWdlOlBhZ2Upe1xuICBhd2FpdCBwYWdlLmV2YWx1YXRlKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgbGV0IHRvdGFsSGVpZ2h0ID0gMDtcbiAgICAgICAgICBjb25zdCBkaXN0YW5jZSA9IDEwMDtcbiAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gODAwMDtcbiAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgIGNvbnN0IHRpbWVyID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmU6IFByb3BlcnR5ICdzY3JvbGxCeScgZG9lcyBub3QgZXhpc3Qgb24gdHlwZSAnV2luZG93J1xuICAgICAgICAgICAgICBjb25zdCBzY3JvbGxIZWlnaHQgPSBkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodDtcbiAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZTogc2Nyb2xsVG8gaXMgbm90IGEgZnVuY3Rpb25cbiAgICAgICAgICAgICAgd2luZG93LnNjcm9sbEJ5KDAsIGRpc3RhbmNlKTtcbiAgICAgICAgICAgICAgdG90YWxIZWlnaHQgKz0gZGlzdGFuY2U7XG5cbiAgICAgICAgICAgICAgY29uc3QgbmV3Tm93ID0gRGF0ZS5ub3coKTtcblxuICAgICAgICAgICAgICBpZihuZXdOb3ctbm93ID4gdGltZW91dCl7XG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZih0b3RhbEhlaWdodCA+PSBzY3JvbGxIZWlnaHQpe1xuICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgfSwgMTAwKTtcbiAgICAgIH0pO1xuICB9KTtcbn0iXX0=