import { Base64 } from 'https://deno.land/x/bb64@1.1.0/mod.ts';
import puppeteer from "https://deno.land/x/puppeteer@9.0.2/mod.ts";
export default async function (item, ctx) {
    let browser = null;
    let page = null;
    const getBrowser = async () => {
        if (browser)
            return browser;
        browser = await puppeteer.launch({
            devtools: false,
            defaultViewport: { width: 768, height: 1024 },
            args: ["--lang=zh-Hans,zh", "--disable-gpu"],
        });
        browser.on("disconnected", () => (browser = null));
        return browser;
    };
    const getNewPage = async (url, force) => {
        if (page)
            return page;
        browser = await getBrowser();
        const pages = await browser.pages();
        if (pages[0] && !force) {
            page = pages[0];
        }
        else {
            page = await browser.newPage();
        }
        await page.setUserAgent("Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36");
        await page.goto(url, { waitUntil: "domcontentloaded" });
        await page.waitForTimeout(4000);
        return page;
    };
    const link = item.links[0].href;
    page = await getNewPage(link, false);
    let b64encoded = "";
    if (page) {
        await autoScroll(page);
        await removeAllLinks(page);
        let scale = 1.6;
        if (link.startsWith("https://news.ycombinator.com")) {
            scale = 2.0;
        }
        const result = await page.pdf({ scale: scale, format: 'a4', omitBackground: true });
        b64encoded = Base64.fromUint8Array(result).toString();
    }
    if (page) {
        await page.close();
    }
    if (browser) {
        await browser.close();
    }
    const title = item.title.value.trim();
    if (b64encoded) {
        const payload = {
            AdvanceErrorHandling: true,
            SandboxMode: false,
            "Messages": [
                {
                    "From": {
                        "Email": ctx.env.FROM_EMAIL,
                        "Name": "Kindle"
                    },
                    "To": [
                        {
                            "Email": ctx.env.TO_EMAIL,
                            "Name": "Try"
                        }
                    ],
                    "Subject": title,
                    "TextPart": item.comments,
                    "CustomID": item.id,
                    "Attachments": [
                        {
                            "Filename": `${title}.pdf`,
                            "ContentType": "application/pdf",
                            "Base64Content": b64encoded
                        }
                    ]
                }
            ]
        };
        return (payload);
    }
    else {
        throw new Error('save pdf error');
    }
}
async function removeAllLinks(page) {
    await page.evaluate(async () => {
        await new Promise((resolve) => {
            const all_links = document.body.getElementsByTagName("a");
            for (let i = 0; i < all_links.length; i++) {
                all_links[i].removeAttribute("href");
            }
            resolve(true);
        });
    });
}
async function autoScroll(page) {
    await page.evaluate(async () => {
        await new Promise((resolve) => {
            let totalHeight = 0;
            const distance = 100;
            const timeout = 8000;
            const now = Date.now();
            const timer = setInterval(() => {
                const scrollHeight = document.body.scrollHeight;
                window.scrollBy(0, distance);
                totalHeight += distance;
                const newNow = Date.now();
                if (newNow - now > timeout) {
                    clearInterval(timer);
                    resolve(true);
                    return;
                }
                if (totalHeight >= scrollHeight) {
                    clearInterval(timer);
                    resolve(true);
                }
            }, 100);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2F2ZS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzYXZlLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDN0QsT0FBTyxTQUdOLE1BQU0sNENBQTRDLENBQUM7QUFFcEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFdBQVcsSUFBMkMsRUFBQyxHQUFpQjtJQUMxRixJQUFJLE9BQU8sR0FBbUIsSUFBSSxDQUFDO0lBQ25DLElBQUksSUFBSSxHQUFnQixJQUFJLENBQUM7SUFDN0IsTUFBTSxVQUFVLEdBQUcsS0FBSyxJQUFJLEVBQUU7UUFDNUIsSUFBSSxPQUFPO1lBQUUsT0FBTyxPQUFPLENBQUM7UUFDNUIsT0FBTyxHQUFHLE1BQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUMvQixRQUFRLEVBQUUsS0FBSztZQUVmLGVBQWUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtZQUM3QyxJQUFJLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxlQUFlLENBQUM7U0FDN0MsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNuRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDLENBQUM7SUFFRixNQUFNLFVBQVUsR0FBRyxLQUFLLEVBQUUsR0FBVSxFQUFDLEtBQWMsRUFBaUIsRUFBRTtRQUNwRSxJQUFJLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUN0QixPQUFPLEdBQUcsTUFBTSxVQUFVLEVBQUUsQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFB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QUM7b0JBQzNCLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNqQjtZQUNMLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtCYXNlNjR9IGZyb20gJ2h0dHBzOi8vZGVuby5sYW5kL3gvYmI2NEAxLjEuMC9tb2QudHMnO1xuaW1wb3J0IHB1cHBldGVlciwge1xuICBCcm93c2VyLFxuICBQYWdlLFxufSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9wdXBwZXRlZXJAOS4wLjIvbW9kLnRzXCI7XG5pbXBvcnQgdHlwZSB7UHVibGljQ29udGV4dH0gZnJvbSAnaHR0cHM6Ly9kZW5vLmxhbmQveC9kZW5vZmxvd0AwLjAuMjcvbW9kLnRzJztcbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChpdGVtOlJlY29yZDxzdHJpbmcsUmVjb3JkPHN0cmluZyxzdHJpbmc+W10+LGN0eDpQdWJsaWNDb250ZXh0KSB7ICBcbiAgbGV0IGJyb3dzZXI6IEJyb3dzZXIgfCBudWxsID0gbnVsbDtcbiAgbGV0IHBhZ2U6IFBhZ2UgfCBudWxsID0gbnVsbDtcbiAgY29uc3QgZ2V0QnJvd3NlciA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoYnJvd3NlcikgcmV0dXJuIGJyb3dzZXI7XG4gICAgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlci5sYXVuY2goe1xuICAgICAgZGV2dG9vbHM6IGZhbHNlLFxuICAgICAgLy8gaGVhZGxlc3M6ICFpc0RldixcbiAgICAgIGRlZmF1bHRWaWV3cG9ydDogeyB3aWR0aDogNzY4LCBoZWlnaHQ6IDEwMjQgfSxcbiAgICAgIGFyZ3M6IFtcIi0tbGFuZz16aC1IYW5zLHpoXCIsIFwiLS1kaXNhYmxlLWdwdVwiXSxcbiAgICB9KTtcbiAgICBicm93c2VyLm9uKFwiZGlzY29ubmVjdGVkXCIsICgpID0+IChicm93c2VyID0gbnVsbCkpO1xuICAgIHJldHVybiBicm93c2VyO1xuICB9O1xuXG4gIGNvbnN0IGdldE5ld1BhZ2UgPSBhc3luYyAodXJsOnN0cmluZyxmb3JjZTogYm9vbGVhbik6IFByb21pc2U8UGFnZT4gPT4ge1xuICAgIGlmIChwYWdlKSByZXR1cm4gcGFnZTtcbiAgICBicm93c2VyID0gYXdhaXQgZ2V0QnJvd3NlcigpO1xuICAgIGNvbnN0IHBhZ2VzID0gYXdhaXQgYnJvd3Nlci5wYWdlcygpO1xuICAgIGlmIChwYWdlc1swXSAmJiAhZm9yY2UpIHtcbiAgICAgIHBhZ2UgPSBwYWdlc1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFnZSA9IGF3YWl0IGJyb3dzZXIubmV3UGFnZSgpO1xuICAgIH1cbiAgICBhd2FpdCBwYWdlLnNldFVzZXJBZ2VudChcbiAgICAgIFwiTW96aWxsYS81LjAgKFgxMTsgTGludXggeDg2XzY0KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvNzguMC4zOTA0LjEwOCBTYWZhcmkvNTM3LjM2XCJcbiAgICApO1xuICAgIC8vIGF3YWl0IHBhZ2Uuc2V0Vmlld3BvcnQoeyB3aWR0aDogMTM3MCwgaGVpZ2h0OiAxMjAwIH0pO1xuICAgIGF3YWl0IHBhZ2UuZ290byh1cmwsIHsgd2FpdFVudGlsOiBcImRvbWNvbnRlbnRsb2FkZWRcIiB9KTtcblxuICAgIGF3YWl0IHBhZ2Uud2FpdEZvclRpbWVvdXQoNDAwMCk7XG4gICAgLy8gYXdhaXQgcGFnZS5zY3JlZW5zaG90KHsgcGF0aDogXCJleGFtcGxlLnBuZ1wiIH0pO1xuXG4gICAgcmV0dXJuIHBhZ2U7XG4gIH07XG4gIGNvbnN0IGxpbmsgPSBpdGVtLmxpbmtzWzBdLmhyZWYgYXMgc3RyaW5nOyAgXG4gICAgcGFnZSA9IGF3YWl0IGdldE5ld1BhZ2UobGluayxmYWxzZSk7XG4gIGxldCBiNjRlbmNvZGVkICA9IFwiXCI7XG4gIGlmKHBhZ2Upe1xuXG4gICBhd2FpdCBhdXRvU2Nyb2xsKHBhZ2UpO1xuXG4gICBhd2FpdCByZW1vdmVBbGxMaW5rcyhwYWdlKTtcbiAgIGxldCBzY2FsZSA9IDEuNjtcblxuICAgaWYobGluay5zdGFydHNXaXRoKFwiaHR0cHM6Ly9uZXdzLnljb21iaW5hdG9yLmNvbVwiKSl7XG4gICAgIHNjYWxlID0gMi4wO1xuICAgfVxuXG4gICAgLy8gc2F2ZSBcbiAgICAvLyBwYXRoOiAnLi9jaGFuZ2VkL3Rlc3QucGRmJ1xuICAgY29uc3QgcmVzdWx0ID0gIGF3YWl0IHBhZ2UucGRmKHtzY2FsZTpzY2FsZSwgZm9ybWF0OiAnYTQnLG9taXRCYWNrZ3JvdW5kOnRydWUgfSk7XG4gICBcbiAgICAvLyBnZXQgYmFzZTY0XG4gICAgLy8gY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigndXRmLTgnKTtcbiAgICAgYjY0ZW5jb2RlZCA9QmFzZTY0LmZyb21VaW50OEFycmF5KHJlc3VsdCkudG9TdHJpbmcoKTtcblxuICB9XG5cbiAgaWYgKHBhZ2UpIHtcbiAgICBhd2FpdCBwYWdlLmNsb3NlKCk7XG4gIH1cbiAgLy8gcXVpdCBwdXBwZXRlZXJcbiAgaWYgKGJyb3dzZXIpIHtcbiAgICBhd2FpdCAoYnJvd3NlciBhcyBCcm93c2VyKSEuY2xvc2UoKTtcbiAgfVxuICAvLyBjb25zdCB0aXRsZSA9IFwidGVzdFwiO1xuICBjb25zdCB0aXRsZSA9IChpdGVtLnRpdGxlIGFzIHVua25vd24gYXMgUmVjb3JkPHN0cmluZyxzdHJpbmc+KS52YWx1ZS50cmltKCk7XG4gIFxuICBpZihiNjRlbmNvZGVkKXtcbiAgICBjb25zdCBwYXlsb2FkID0gIHtcbiAgICAgIEFkdmFuY2VFcnJvckhhbmRsaW5nOnRydWUsXG4gICAgICBTYW5kYm94TW9kZTpmYWxzZSxcbiAgICAgIFwiTWVzc2FnZXNcIjpbXG4gICAgICAgIHtcbiAgICAgICAgICBcIkZyb21cIjoge1xuICAgICAgICAgICAgXCJFbWFpbFwiOiBjdHguZW52LkZST01fRU1BSUwsXG4gICAgICAgICAgICBcIk5hbWVcIjogXCJLaW5kbGVcIlxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJUb1wiOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFwiRW1haWxcIjogY3R4LmVudi5UT19FTUFJTCxcbiAgICAgICAgICAgICAgXCJOYW1lXCI6IFwiVHJ5XCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdLFxuICAgICAgICAgIFwiU3ViamVjdFwiOiB0aXRsZSxcbiAgICAgICAgICBcIlRleHRQYXJ0XCI6IGl0ZW0uY29tbWVudHMsXG4gICAgICAgICAgXCJDdXN0b21JRFwiOiBpdGVtLmlkLCAgXG4gICAgICAgICAgXCJBdHRhY2htZW50c1wiOltcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgXCJGaWxlbmFtZVwiOmAke3RpdGxlfS5wZGZgLFxuICAgICAgICAgICAgICBcIkNvbnRlbnRUeXBlXCI6XCJhcHBsaWNhdGlvbi9wZGZcIixcbiAgICAgICAgICAgICAgXCJCYXNlNjRDb250ZW50XCI6YjY0ZW5jb2RlZFxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0gICAgXG4gICAgcmV0dXJuIChwYXlsb2FkKTtcbiAgfWVsc2V7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdzYXZlIHBkZiBlcnJvcicpXG4gIH1cblxufVxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlQWxsTGlua3MocGFnZTpQYWdlKXtcbiAgYXdhaXQgcGFnZS5ldmFsdWF0ZShhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgLy8gQHRzLWlnbm9yZTogc2Nyb2xsVG8gaXMgbm90IGEgZnVuY3Rpb25cbiAgY29uc3QgYWxsX2xpbmtzID0gZG9jdW1lbnQuYm9keS5nZXRFbGVtZW50c0J5VGFnTmFtZShcImFcIik7XG5cbiAgZm9yKGxldCBpPTA7IGk8YWxsX2xpbmtzLmxlbmd0aDsgaSsrKXtcbiAgICAgIGFsbF9saW5rc1tpXS5yZW1vdmVBdHRyaWJ1dGUoXCJocmVmXCIpO1xuICB9XG4gIHJlc29sdmUodHJ1ZSk7XG4gICAgfSk7XG59KTtcblxuXG59XG5hc3luYyBmdW5jdGlvbiBhdXRvU2Nyb2xsKHBhZ2U6UGFnZSl7XG4gIGF3YWl0IHBhZ2UuZXZhbHVhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICBsZXQgdG90YWxIZWlnaHQgPSAwO1xuICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gMTAwO1xuICAgICAgICAgIGNvbnN0IHRpbWVvdXQgPSA4MDAwO1xuICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgY29uc3QgdGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgLy8gQHRzLWlnbm9yZTogUHJvcGVydHkgJ3Njcm9sbEJ5JyBkb2VzIG5vdCBleGlzdCBvbiB0eXBlICdXaW5kb3cnXG4gICAgICAgICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlOiBzY3JvbGxUbyBpcyBub3QgYSBmdW5jdGlvblxuICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgZGlzdGFuY2UpO1xuICAgICAgICAgICAgICB0b3RhbEhlaWdodCArPSBkaXN0YW5jZTtcblxuICAgICAgICAgICAgICBjb25zdCBuZXdOb3cgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgICAgICAgIGlmKG5ld05vdy1ub3cgPiB0aW1lb3V0KXtcbiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmKHRvdGFsSGVpZ2h0ID49IHNjcm9sbEhlaWdodCl7XG4gICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCAxMDApO1xuICAgICAgfSk7XG4gIH0pO1xufSJdfQ==